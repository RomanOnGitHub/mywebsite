---
import Layout from '@/layouts/Layout.astro';
import { SUPPORTED_LOCALES, type Locale, getLocalizedPath } from '@/utils/slugs';

export function getStaticPaths() {
  return SUPPORTED_LOCALES.map(lang => ({ 
    params: { lang } 
  }));
}

const { lang } = Astro.params as { lang: Locale };
---

<Layout 
  title="–ì—Ä–∞—Ñ –∑–Ω–∞–Ω–∏–π" 
  description="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–≤—è–∑–µ–π –º–µ–∂–¥—É –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏"
  lang={lang}
>
  <div class="max-w-7xl mx-auto">
    <header class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-4xl font-bold">–ì—Ä–∞—Ñ –∑–Ω–∞–Ω–∏–π</h1>
        <a 
          href={getLocalizedPath('', lang)}
          class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 underline transition-colors"
          data-astro-prefetch
        >
          ‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é
        </a>
      </div>
      <p class="text-lg text-gray-600 dark:text-gray-400">
        –ò—Å—Å–ª–µ–¥—É–π—Ç–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ —Å–∞–π—Ç–∞
      </p>
    </header>
    
    <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
    <div class="mb-6 space-y-4">
      <!-- –ü–æ–∏—Å–∫ —É–∑–ª–æ–≤ -->
      <div class="flex items-center gap-2">
        <label for="search-nodes" class="text-sm font-medium text-gray-700 dark:text-gray-300">
          üîç –ü–æ–∏—Å–∫:
        </label>
        <input
          type="text"
          id="search-nodes"
          placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–∑–ª–∞..."
          class="flex-1 max-w-md border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:outline-none"
        />
        <button
          id="clear-search"
          class="px-3 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md transition-colors text-sm"
          style="display: none;"
        >
          ‚úï –û—á–∏—Å—Ç–∏—Ç—å
        </button>
      </div>
      
      <!-- –§–∏–ª—å—Ç—Ä—ã -->
      <div class="flex flex-wrap gap-4 items-center">
        <div class="flex items-center gap-2">
          <label for="filter-type" class="text-sm font-medium text-gray-700 dark:text-gray-300">
            –¢–∏–ø:
          </label>
          <select 
            id="filter-type"
            class="border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500"
          >
            <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
            <option value="blog">–ë–ª–æ–≥</option>
            <option value="cases">–ö–µ–π—Å—ã</option>
            <option value="services">–£—Å–ª—É–≥–∏</option>
            <option value="industries">–û—Ç—Ä–∞—Å–ª–∏</option>
          </select>
        </div>
        
        <div class="flex items-center gap-2">
          <label for="filter-tags" class="text-sm font-medium text-gray-700 dark:text-gray-300">
            –¢–µ–≥:
          </label>
          <select 
            id="filter-tags"
            class="border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500"
          >
            <option value="">–í—Å–µ —Ç–µ–≥–∏</option>
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ graph.nodes -->
          </select>
        </div>
        
        <button
          id="reset-filters"
          class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md transition-colors text-sm"
        >
          –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        </button>
      </div>
    </div>
    
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∞ -->
    <div 
      id="graph-container" 
      class="border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 overflow-hidden relative"
      style="width: 100%; height: 600px;"
    ></div>
    
    <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è –≥—Ä–∞—Ñ–∞ -->
    <div class="mt-4 flex flex-wrap gap-2 items-center justify-center text-sm">
      <button
        id="zoom-in"
        class="px-3 py-1.5 bg-blue-600 dark:bg-blue-500 hover:bg-blue-700 dark:hover:bg-blue-600 text-white rounded-md transition-colors"
        title="–£–≤–µ–ª–∏—á–∏—Ç—å"
      >
        üîç+
      </button>
      <button
        id="zoom-out"
        class="px-3 py-1.5 bg-blue-600 dark:bg-blue-500 hover:bg-blue-700 dark:hover:bg-blue-600 text-white rounded-md transition-colors"
        title="–£–º–µ–Ω—å—à–∏—Ç—å"
      >
        üîç-
      </button>
      <button
        id="zoom-fit"
        class="px-3 py-1.5 bg-blue-600 dark:bg-blue-500 hover:bg-blue-700 dark:hover:bg-blue-600 text-white rounded-md transition-colors"
        title="–ü–æ–¥–æ–≥–Ω–∞—Ç—å –ø–æ–¥ —Ä–∞–∑–º–µ—Ä"
      >
        ‚õ∂ –ü–æ–¥–æ–≥–Ω–∞—Ç—å
      </button>
      <button
        id="zoom-reset"
        class="px-3 py-1.5 bg-gray-600 dark:bg-gray-500 hover:bg-gray-700 dark:hover:bg-gray-600 text-white rounded-md transition-colors"
        title="–°–±—Ä–æ—Å–∏—Ç—å zoom"
      >
        ‚Ü∫ –°–±—Ä–æ—Å–∏—Ç—å
      </button>
      <button
        id="export-image"
        class="px-3 py-1.5 bg-green-600 dark:bg-green-500 hover:bg-green-700 dark:hover:bg-green-600 text-white rounded-md transition-colors"
        title="–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
      >
        üì• –≠–∫—Å–ø–æ—Ä—Ç
      </button>
      <div class="text-gray-600 dark:text-gray-400 ml-4">
        <span class="text-xs">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–ª–µ—Å–æ –º—ã—à–∏ –¥–ª—è zoom, –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è</span>
      </div>
    </div>
    
    <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (—Å–∫—Ä—ã—Ç–æ–µ) -->
    <div
      id="context-menu"
      class="hidden fixed bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg py-1 z-50"
      style="min-width: 150px;"
    >
      <button
        id="context-copy-node"
        class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm"
      >
        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —É–∑–ª–∞
      </button>
      <button
        id="context-open-new"
        class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm"
      >
        üîó –û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
      </button>
      <button
        id="context-highlight-connections"
        class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm"
      >
        ‚ú® –í—ã–¥–µ–ª–∏—Ç—å —Å–≤—è–∑–∏
      </button>
    </div>
    
    <!-- –õ–µ–≥–µ–Ω–¥–∞ -->
    <div class="mt-6 flex flex-wrap gap-4 text-sm">
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-blue-500"></div>
        <span>–ë–ª–æ–≥</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-green-500"></div>
        <span>–ö–µ–π—Å—ã</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-yellow-500"></div>
        <span>–£—Å–ª—É–≥–∏</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-purple-500"></div>
        <span>–û—Ç—Ä–∞—Å–ª–∏</span>
      </div>
    </div>
  </div>
</Layout>

<script>
  import type { GraphNode, GraphEdge, GraphData } from '@/types/graph';
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ DOM API
  if (typeof window === 'undefined') {
    throw new Error('This script must run in browser environment');
  }
  
  // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
  let ForceGraph: any = null;
  let forceCenter: any = null;
  let forceManyBody: any = null;
  let forceLink: any = null;
  
  // –ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
  async function loadGraphLibraries() {
    if (!ForceGraph) {
      const forceGraphModule = await import('force-graph');
      ForceGraph = forceGraphModule.default;
    }
    if (!forceCenter) {
      const d3ForceModule = await import('d3-force');
      forceCenter = d3ForceModule.forceCenter;
      forceManyBody = d3ForceModule.forceManyBody;
      forceLink = d3ForceModule.forceLink;
    }
  }
  
  let graph: any = null;
  let allData: GraphData | null = null;
  let highlightedNodeId: string | null = null;
  let contextMenuNode: GraphNode | null = null;
  const lang = document.documentElement.lang || 'ru';
  
  async function init() {
    try {
      // –ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
      await loadGraphLibraries();
      
      const res = await fetch(`/graph-data-${lang}.json`);
      if (!res.ok) {
        console.error('Failed to load graph data');
        return;
      }
      
      allData = await res.json() as GraphData;
      
      // –ó–∞–ø–æ–ª–Ω–∏—Ç—å select —Å —Ç–µ–≥–∞–º–∏
      const allTags = [...new Set(allData.nodes.flatMap((n) => n.tags || []))].sort();
      const tagsSelect = document.getElementById('filter-tags') as HTMLSelectElement;
      
      // –û—á–∏—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ü–∏–∏ (–∫—Ä–æ–º–µ "–í—Å–µ —Ç–µ–≥–∏")
      while (tagsSelect.options.length > 1) {
        tagsSelect.remove(1);
      }
      
      allTags.forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tag;
        tagsSelect.appendChild(option);
      });
      
      renderGraph(allData);
    } catch (error) {
      console.error('Error loading graph data:', error);
    }
  }
  
  function applyFilters() {
    if (!allData) return;
    
    const typeSelect = document.getElementById('filter-type') as HTMLSelectElement;
    const tagSelect = document.getElementById('filter-tags') as HTMLSelectElement;
    
    const type = typeSelect.value;
    const tag = tagSelect.value;
    
    const filteredNodes = allData.nodes.filter((n) => 
      (!type || n.type === type) &&
      (!tag || (n.tags && n.tags.includes(tag)))
    );
    
    const nodeIds = new Set(filteredNodes.map((n) => n.id));
    const filteredEdges = allData.edges.filter((e) => 
      nodeIds.has(e.from) && nodeIds.has(e.to)
    );
    
    renderGraph({ nodes: filteredNodes, edges: filteredEdges });
  }
  
  function renderGraph(data: GraphData) {
    const container = document.getElementById('graph-container');
    if (!container) return;
    
    // –£–Ω–∏—á—Ç–æ–∂–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ
    if (graph) {
      graph._destructor();
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —á–µ—Ä–µ–∑ getBoundingClientRect
    const rect = container.getBoundingClientRect();
    const width = rect.width || container.clientWidth || 800;
    const height = rect.height || container.clientHeight || 600;
    const margin = 30; // –û—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞—ë–≤
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Math.floor –¥–ª—è —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    const centerX = Math.floor(width / 2);
    const centerY = Math.floor(height / 2);
    
    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    console.log('Graph container:', { width, height, centerX, centerY });
    console.log('Graph data:', { nodes: data.nodes.length, edges: data.edges.length });
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
    if (data.nodes.length === 0) {
      console.warn('No nodes to display');
      return;
    }
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å edges –≤ links –¥–ª—è force-graph
    // force-graph –æ–∂–∏–¥–∞–µ—Ç, —á—Ç–æ source –∏ target –±—É–¥—É—Ç —Å—Ç—Ä–æ–∫–∞–º–∏ (ID) –∏–ª–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏ —É–∑–ª–æ–≤
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫–∏ (ID) –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã - force-graph —Å–∞–º –Ω–∞–π–¥—ë—Ç —É–∑–ª—ã
    const links = data.edges.map((e) => ({
      source: e.from, // ID —É–∑–ª–∞-–∏—Å—Ç–æ—á–Ω–∏–∫–∞
      target: e.to,   // ID —É–∑–ª–∞-—Ü–µ–ª–∏
      sourceType: e.source, // 'explicit' | 'outbound' - –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
    }));
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã —É–∑–ª–æ–≤ –¥–ª—è —É—á—ë—Ç–∞ –≤ –≥—Ä–∞–Ω–∏—Ü–∞—Ö
    const nodeSizes = new Map<string, number>();
    data.nodes.forEach((node) => {
      const connections = data.edges.filter((e) => 
        e.from === node.id || e.to === node.id
      ).length;
      const size = Math.max(5, Math.min(20, connections * 2));
      nodeSizes.set(node.id, size);
    });
    
    // –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å–∏–ª–∞ –¥–ª—è –º—è–≥–∫–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü
    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ —É–∑–ª–æ–≤, –∫–æ–≥–¥–∞ –æ–Ω–∏ –≤—ã—Ö–æ–¥—è—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã
    // –≠—Ç–æ –Ω–µ —Ö–∞—Ä–¥–∫–æ–¥ - –º—ã –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏, –∞ —Ç–æ–ª—å–∫–æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Å–∫–æ—Ä–æ—Å—Ç–∏
    const boundingBoxForce = () => {
      let nodes: Array<GraphNode & { x?: number; y?: number; vx?: number; vy?: number }>;
      
      const force = (alpha: number) => {
        nodes.forEach((node) => {
          const nodeSize = nodeSizes.get(node.id) || 10;
          const xMin = margin + nodeSize;
          const xMax = width - margin - nodeSize;
          const yMin = margin + nodeSize;
          const yMax = height - margin - nodeSize;
          
          // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å, –µ—Å–ª–∏ —É–∑–µ–ª –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç 0.1 –¥–ª—è –º—è–≥–∫–æ—Å—Ç–∏
          if (node.x! < xMin) {
            node.vx = (node.vx || 0) + (xMin - node.x!) * 0.1;
          }
          if (node.x! > xMax) {
            node.vx = (node.vx || 0) + (xMax - node.x!) * 0.1;
          }
          if (node.y! < yMin) {
            node.vy = (node.vy || 0) + (yMin - node.y!) * 0.1;
          }
          if (node.y! > yMax) {
            node.vy = (node.vy || 0) + (yMax - node.y!) * 0.1;
          }
        });
      };
      
      force.initialize = (n: Array<GraphNode & { x?: number; y?: number; vx?: number; vy?: number }>) => {
        nodes = n;
      };
      
      return force;
    };
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —É–∑–ª–æ–≤ –ü–ï–†–ï–î —Å–æ–∑–¥–∞–Ω–∏–µ–º –≥—Ä–∞—Ñ–∞
    // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø–æ–∑–∏—Ü–∏–∏ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    data.nodes.forEach((node, index: number) => {
      // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —É–∑–ª—ã —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –ø–æ –∫—Ä—É–≥—É –≤–æ–∫—Ä—É–≥ —Ü–µ–Ω—Ç—Ä–∞
      const angle = (index / data.nodes.length) * Math.PI * 2;
      const radius = Math.min(width, height) * 0.1;
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –≤ —Ü–µ–Ω—Ç—Ä–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      // –í–∞–∂–Ω–æ: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é –≤ –æ–±—ä–µ–∫—Ç —É–∑–ª–∞
      node.x = centerX + Math.cos(angle) * radius;
      node.y = centerY + Math.sin(angle) * radius;
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤ 0
      node.vx = 0;
      node.vy = 0;
    });
    
    // –°–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ
    // force-graph –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏ –≤ links, –Ω–æ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã —É–∑–ª–æ–≤
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º links —Ç–∞–∫, —á—Ç–æ–±—ã source –∏ target –±—ã–ª–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏ —É–∑–ª–æ–≤
    const linksWithNodes = links.map(link => {
      const sourceNode = data.nodes.find(n => n.id === link.source);
      const targetNode = data.nodes.find(n => n.id === link.target);
      
      if (!sourceNode || !targetNode) {
        console.warn('Link references missing node:', { source: link.source, target: link.target });
        return null;
      }
      
      return {
        source: sourceNode,
        target: targetNode,
        sourceType: link.sourceType,
      };
    }).filter((link): link is NonNullable<typeof link> => link !== null);
    
    console.log('Links with nodes:', linksWithNodes.length, 'out of', links.length);
    
    graph = ForceGraph()(container)
      .graphData({ nodes: data.nodes, links: linksWithNodes })
      .width(width)
      .height(height)
      .nodeLabel((n: GraphNode) => n.title)
      .nodeColor((n: GraphNode) => {
        const colors: Record<GraphNode['type'], string> = {
          blog: '#3b82f6',
          cases: '#10b981',
          services: '#f59e0b',
          industries: '#8b5cf6',
        };
        return colors[n.type] || '#6b7280';
      })
      .nodeVal((n: GraphNode) => nodeSizes.get(n.id) || 10)
      .linkWidth((link: any) => {
        // –Ø—Ä—á–µ –¥–ª—è explicit —Å–≤—è–∑–µ–π, —Ç–æ–Ω—å—à–µ –¥–ª—è outbound
        return link.sourceType === 'explicit' ? 2 : 1.5;
      })
      .linkColor((link: any) => {
        // –Ø—Ä–∫–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —Ä—ë–±–µ—Ä, —Ö–æ—Ä–æ—à–æ –≤–∏–¥–∏–º—ã–µ –Ω–∞ —Ç—ë–º–Ω–æ–º —Ñ–æ–Ω–µ
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º rgba –¥–ª—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ (0.8 = 80% –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏)
        if (link.sourceType === 'explicit') {
          // –Ø—Ä–∫–∏–π —Å–∏–Ω–∏–π –¥–ª—è explicit —Å–≤—è–∑–µ–π —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
          return 'rgba(96, 165, 250, 0.8)'; // blue-400 —Å opacity 0.8
        } else {
          // –Ø—Ä–∫–∏–π —Å–µ—Ä–æ-—Å–∏–Ω–∏–π –¥–ª—è outbound —Å–≤—è–∑–µ–π —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
          return 'rgba(148, 163, 184, 0.8)'; // slate-400 —Å opacity 0.8
        }
      })
      .linkDirectionalArrowLength(6)
      .linkDirectionalArrowRelPos(1)
      .d3Force('center', forceCenter(width / 2, height / 2))
      .d3Force('charge', forceManyBody().strength(-300))
      .d3Force('link', forceLink(linksWithNodes as any).id((d: any) => {
        // d - —ç—Ç–æ –æ–±—ä–µ–∫—Ç —É–∑–ª–∞, –∏–∑–≤–ª–µ–∫–∞–µ–º id
        if (d && typeof d === 'object' && 'id' in d) return d.id;
        return String(d);
      }).distance(100))
      .d3Force('boundingBox', boundingBoxForce())
      // Zoom –∏ pan –∫–æ–Ω—Ç—Ä–æ–ª—ã (force-graph –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ)
      .enableZoomInteraction(true)
      .enablePanInteraction(true)
      .cooldownTicks(100) // –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
      .onNodeClick((node: GraphNode) => {
        if (typeof window !== 'undefined' && node) {
          const url = `/${lang}/${node.id}/`;
          window.location.href = url;
        }
      })
      .onNodeHover((node: GraphNode | null) => {
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        if (node) {
          container.style.cursor = 'pointer';
          highlightConnections(node.id);
        } else {
          container.style.cursor = 'default';
          clearHighlight();
        }
      })
      .onNodeRightClick((node: GraphNode, event: MouseEvent) => {
        // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –ø—Ä–∞–≤–æ–º –∫–ª–∏–∫–µ
        event.preventDefault();
        contextMenuNode = node;
        showContextMenu(event.clientX, event.clientY);
      })
      .onLinkHover((link: any) => {
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ä—ë–±–µ—Ä –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        if (link) {
          container.style.cursor = 'pointer';
        }
      });
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π zoom –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∞
    setTimeout(() => {
      if (graph) {
        graph.zoomToFit(400);
      }
    }, 100);
  }
  
  function resetFilters() {
    const typeSelect = document.getElementById('filter-type') as HTMLSelectElement;
    const tagSelect = document.getElementById('filter-tags') as HTMLSelectElement;
    
    typeSelect.value = '';
    tagSelect.value = '';
    
    if (allData) {
      renderGraph(allData);
    }
  }
  
  // –ü–æ–∏—Å–∫ —É–∑–ª–æ–≤
  function searchNodes(searchText: string) {
    if (!allData || !graph) return;
    
    const query = searchText.toLowerCase().trim();
    if (!query) {
      clearSearch();
      return;
    }
    
    // –ù–∞–π—Ç–∏ —É–∑–ª—ã, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
    const matchingNodes = allData.nodes.filter(node => 
      node.title.toLowerCase().includes(query) ||
      node.id.toLowerCase().includes(query) ||
      (node.tags && node.tags.some(tag => tag.toLowerCase().includes(query)))
    );
    
    if (matchingNodes.length > 0) {
      // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ø–µ—Ä–≤–æ–º –Ω–∞–π–¥–µ–Ω–Ω–æ–º —É–∑–ª–µ
      const firstNode = matchingNodes[0];
      const graphData = graph.graphData();
      const nodeObj = graphData.nodes.find((n: any) => n.id === firstNode.id);
      
      if (nodeObj && nodeObj.x !== undefined && nodeObj.y !== undefined) {
        graph.centerAt(nodeObj.x, nodeObj.y, 1000);
        graph.zoomToFit(400, 20);
        
        // –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É–∑–ª—ã
        highlightSearchResults(matchingNodes.map(n => n.id));
      }
    } else {
      clearSearch();
      showNotification('–£–∑–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning');
    }
  }
  
  function highlightSearchResults(nodeIds: string[]) {
    if (!graph) return;
    
    // –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É–∑–ª–æ–≤ —á–µ—Ä–µ–∑ nodeVal
    const originalNodeVal = graph.nodeVal();
    graph.nodeVal((node: any) => {
      const baseSize = typeof originalNodeVal === 'function' ? originalNodeVal(node) : 10;
      return nodeIds.includes(node.id) ? baseSize * 1.5 : baseSize;
    });
    
    // –ò–∑–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É–∑–ª–æ–≤
    const originalNodeColor = graph.nodeColor();
    graph.nodeColor((node: any) => {
      if (nodeIds.includes(node.id)) {
        return '#fbbf24'; // –ñ—ë–ª—Ç—ã–π –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É–∑–ª–æ–≤
      }
      // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Ü–≤–µ—Ç–∞
      if (typeof originalNodeColor === 'function') {
        return originalNodeColor(node);
      }
      // –í–µ—Ä–Ω—É—Ç—å –æ–±—ã—á–Ω—ã–µ —Ü–≤–µ—Ç–∞
      return getDefaultNodeColor(node);
    });
  }
  
  function clearSearch() {
    if (!graph || !allData) return;
    
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±—ã—á–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã —É–∑–ª–æ–≤
    const nodeSizes = new Map<string, number>();
    allData.nodes.forEach((node) => {
      const connections = allData.edges.filter((e) => 
        e.from === node.id || e.to === node.id
      ).length;
      const size = Math.max(5, Math.min(20, connections * 2));
      nodeSizes.set(node.id, size);
    });
    
    graph.nodeVal((n: GraphNode) => nodeSizes.get(n.id) || 10);
    
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±—ã—á–Ω—ã–µ —Ü–≤–µ—Ç–∞
    graph.nodeColor((n: GraphNode) => getDefaultNodeColor(n));
  }
  
  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤
  function highlightConnections(nodeId: string) {
    if (!graph || !allData || highlightedNodeId === nodeId) return;
    
    highlightedNodeId = nodeId;
    const connectedNodeIds = new Set<string>([nodeId]);
    
    // –ù–∞–π—Ç–∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —É–∑–ª—ã
    allData.edges.forEach(edge => {
      if (edge.from === nodeId) connectedNodeIds.add(edge.to);
      if (edge.to === nodeId) connectedNodeIds.add(edge.from);
    });
    
    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞
    const originalNodeColor = graph.nodeColor();
    const originalLinkColor = graph.linkColor();
    
    // –ò–∑–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤ (–∑–∞—Ç–µ–º–Ω–∏—Ç—å)
    graph.nodeColor((node: any) => {
      const baseColor = typeof originalNodeColor === 'function' ? originalNodeColor(node) : getDefaultNodeColor(node);
      if (connectedNodeIds.has(node.id)) {
        return baseColor; // –û—Å—Ç–∞–≤–∏—Ç—å —è—Ä–∫–∏–º
      }
      // –ó–∞—Ç–µ–º–Ω–∏—Ç—å –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ —É–∑–ª—ã (–¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ rgba)
      return addOpacityToColor(baseColor, 0.3);
    });
    
    // –ò–∑–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç —Ä—ë–±–µ—Ä
    graph.linkColor((link: any) => {
      const sourceId = typeof link.source === 'string' ? link.source : link.source?.id;
      const targetId = typeof link.target === 'string' ? link.target : link.target?.id;
      const isConnected = sourceId === nodeId || targetId === nodeId;
      
      if (isConnected) {
        const baseColor = typeof originalLinkColor === 'function' ? originalLinkColor(link) : 'rgba(96, 165, 250, 0.8)';
        return baseColor.replace('0.8', '1'); // –£–±—Ä–∞—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö
      }
      // –ó–∞—Ç–µ–º–Ω–∏—Ç—å –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ä—ë–±—Ä–∞
      return 'rgba(148, 163, 184, 0.2)';
    });
  }
  
  function clearHighlight() {
    if (!graph || highlightedNodeId === null) return;
    
    highlightedNodeId = null;
    
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±—ã—á–Ω—ã–µ —Ü–≤–µ—Ç–∞ —É–∑–ª–æ–≤
    graph.nodeColor((n: GraphNode) => getDefaultNodeColor(n));
    
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±—ã—á–Ω—ã–µ —Ü–≤–µ—Ç–∞ —Ä—ë–±–µ—Ä
    graph.linkColor((link: any) => {
      if (link.sourceType === 'explicit') {
        return 'rgba(96, 165, 250, 0.8)';
      } else {
        return 'rgba(148, 163, 184, 0.8)';
      }
    });
  }
  
  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —É–∑–ª–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  function getDefaultNodeColor(node: GraphNode): string {
    const colors: Record<GraphNode['type'], string> = {
      blog: '#3b82f6',
      cases: '#10b981',
      services: '#f59e0b',
      industries: '#8b5cf6',
    };
    return colors[node.type] || '#6b7280';
  }
  
  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –∫ —Ü–≤–µ—Ç—É
  function addOpacityToColor(color: string, opacity: number): string {
    // –ï—Å–ª–∏ —Ü–≤–µ—Ç —É–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ rgba, –∑–∞–º–µ–Ω–∏—Ç—å opacity
    if (color.startsWith('rgba(')) {
      return color.replace(/[\d.]+\)$/, `${opacity})`);
    }
    // –ï—Å–ª–∏ —Ü–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ hex, –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ rgba
    if (color.startsWith('#')) {
      const r = parseInt(color.slice(1, 3), 16);
      const g = parseInt(color.slice(3, 5), 16);
      const b = parseInt(color.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${opacity})`;
    }
    // –ï—Å–ª–∏ —Ü–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ rgb, –¥–æ–±–∞–≤–∏—Ç—å alpha
    if (color.startsWith('rgb(')) {
      return color.replace('rgb(', 'rgba(').replace(')', `, ${opacity})`);
    }
    // Fallback: –≤–µ—Ä–Ω—É—Ç—å —Ü–≤–µ—Ç –∫–∞–∫ –µ—Å—Ç—å
    return color;
  }
  
  // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
  function showContextMenu(x: number, y: number) {
    const menu = document.getElementById('context-menu');
    if (!menu || !contextMenuNode) return;
    
    menu.style.left = `${x}px`;
    menu.style.top = `${y}px`;
    menu.classList.remove('hidden');
  }
  
  function hideContextMenu() {
    const menu = document.getElementById('context-menu');
    if (menu) {
      menu.classList.add('hidden');
    }
  }
  
  // –≠–∫—Å–ø–æ—Ä—Ç –≥—Ä–∞—Ñ–∞ –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  async function exportGraphAsImage() {
    if (!graph || !container) return;
    
    try {
      // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç html-to-image
      const { toPng } = await import('html-to-image');
      
      // –°–±—Ä–æ—Å–∏—Ç—å zoom –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      graph.zoomToFit(400);
      
      // –ü–æ–¥–æ–∂–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // –î–ª—è WebGL canvas –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏
      const dataUrl = await toPng(container, {
        backgroundColor: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#1f2937' : '#ffffff',
        quality: 1.0,
        pixelRatio: 2,
        cacheBust: true,
        filter: (node: Node) => {
          // –ò—Å–∫–ª—é—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –∏ –¥—Ä—É–≥–∏–µ UI —ç–ª–µ–º–µ–Ω—Ç—ã
          return !(node as Element).id?.includes('context-menu');
        },
      });
      
      // –°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      const link = document.createElement('a');
      link.download = `graph-knowledge-${lang}-${new Date().toISOString().split('T')[0]}.png`;
      link.href = dataUrl;
      link.click();
      
      showNotification('–ì—Ä–∞—Ñ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!', 'success');
    } catch (error) {
      console.error('Export error:', error);
      showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.', 'error');
    }
  }
  
  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  function showNotification(message: string, type: 'success' | 'warning' | 'error' = 'success') {
    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 px-4 py-3 rounded-md shadow-lg z-50 ${
      type === 'success' ? 'bg-green-500 text-white' :
      type === 'warning' ? 'bg-yellow-500 text-black' :
      'bg-red-500 text-white'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }
  
  // Zoom –∫–æ–Ω—Ç—Ä–æ–ª—ã
  function setupZoomControls() {
    const zoomInBtn = document.getElementById('zoom-in');
    const zoomOutBtn = document.getElementById('zoom-out');
    const zoomFitBtn = document.getElementById('zoom-fit');
    const zoomResetBtn = document.getElementById('zoom-reset');
    
    zoomInBtn?.addEventListener('click', () => {
      if (graph) {
        const currentZoom = graph.zoom() || 1;
        graph.zoom(currentZoom * 1.2);
      }
    });
    
    zoomOutBtn?.addEventListener('click', () => {
      if (graph) {
        const currentZoom = graph.zoom() || 1;
        graph.zoom(currentZoom / 1.2);
      }
    });
    
    zoomFitBtn?.addEventListener('click', () => {
      if (graph) {
        graph.zoomToFit(400);
      }
    });
    
    zoomResetBtn?.addEventListener('click', () => {
      if (graph) {
        graph.zoom(1);
        graph.centerAt(0, 0);
      }
    });
  }
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ zoom –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∞
  let zoomControlsSetup = false;
  
  // –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è renderGraph —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤
  const renderGraphWithControls = function(data: GraphData) {
    renderGraph(data);
    // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—ã –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∞ (—Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏)
    setTimeout(() => {
      if (!zoomControlsSetup && graph) {
        setupZoomControls();
        zoomControlsSetup = true;
      }
    }, 100);
  };
  
  // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è renderGraphWithControls
  const originalInit = init;
  init = async function() {
    try {
      // –ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
      await loadGraphLibraries();
      
      const res = await fetch(`/graph-data-${lang}.json`);
      if (!res.ok) {
        console.error('Failed to load graph data');
        return;
      }
      
      allData = await res.json() as GraphData;
      console.log('Loaded graph data:', { nodes: allData.nodes.length, edges: allData.edges.length });
      
      // –ó–∞–ø–æ–ª–Ω–∏—Ç—å select —Å —Ç–µ–≥–∞–º–∏
      const allTags = [...new Set(allData.nodes.flatMap((n) => n.tags || []))].sort();
      const tagsSelect = document.getElementById('filter-tags') as HTMLSelectElement;
      
      // –û—á–∏—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ü–∏–∏ (–∫—Ä–æ–º–µ "–í—Å–µ —Ç–µ–≥–∏")
      while (tagsSelect && tagsSelect.options.length > 1) {
        tagsSelect.remove(1);
      }
      
      allTags.forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tag;
        tagsSelect?.appendChild(option);
      });
      
      renderGraphWithControls(allData);
    } catch (error) {
      console.error('Error loading graph data:', error);
    }
  };
  
  const originalApplyFilters = applyFilters;
  applyFilters = function() {
    if (!allData) return;
    
    const typeSelect = document.getElementById('filter-type') as HTMLSelectElement;
    const tagSelect = document.getElementById('filter-tags') as HTMLSelectElement;
    
    const type = typeSelect.value;
    const tag = tagSelect.value;
    
    const filteredNodes = allData.nodes.filter((n) => 
      (!type || n.type === type) &&
      (!tag || (n.tags && n.tags.includes(tag)))
    );
    
    const nodeIds = new Set(filteredNodes.map((n) => n.id));
    const filteredEdges = allData.edges.filter((e) => 
      nodeIds.has(e.from) && nodeIds.has(e.to)
    );
    
    renderGraphWithControls({ nodes: filteredNodes, edges: filteredEdges });
  };
  
  const originalResetFilters = resetFilters;
  resetFilters = function() {
    const typeSelect = document.getElementById('filter-type') as HTMLSelectElement;
    const tagSelect = document.getElementById('filter-tags') as HTMLSelectElement;
    
    typeSelect.value = '';
    tagSelect.value = '';
    
    if (allData) {
      renderGraphWithControls(allData);
    }
  };
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  document.getElementById('filter-type')?.addEventListener('change', applyFilters);
  document.getElementById('filter-tags')?.addEventListener('change', applyFilters);
  document.getElementById('reset-filters')?.addEventListener('click', resetFilters);
  
  // –ü–æ–∏—Å–∫ —É–∑–ª–æ–≤
  const searchInput = document.getElementById('search-nodes') as HTMLInputElement;
  const clearSearchBtn = document.getElementById('clear-search') as HTMLButtonElement;
  
  let searchTimeout: ReturnType<typeof setTimeout> | null = null;
  searchInput?.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement;
    const value = target.value;
    
    if (value.trim()) {
      clearSearchBtn.style.display = 'block';
    } else {
      clearSearchBtn.style.display = 'none';
      clearSearch();
    }
    
    // Debounce –ø–æ–∏—Å–∫–∞
    if (searchTimeout) clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      if (value.trim()) {
        searchNodes(value);
      }
    }, 300);
  });
  
  clearSearchBtn?.addEventListener('click', () => {
    searchInput.value = '';
    clearSearchBtn.style.display = 'none';
    clearSearch();
  });
  
  // –≠–∫—Å–ø–æ—Ä—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  document.getElementById('export-image')?.addEventListener('click', exportGraphAsImage);
  
  // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
  document.getElementById('context-copy-node')?.addEventListener('click', async () => {
    if (contextMenuNode) {
      try {
        await navigator.clipboard.writeText(JSON.stringify(contextMenuNode, null, 2));
        showNotification('–î–∞–Ω–Ω—ã–µ —É–∑–ª–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!', 'success');
      } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
      }
    }
    hideContextMenu();
  });
  
  document.getElementById('context-open-new')?.addEventListener('click', () => {
    if (contextMenuNode) {
      window.open(`/${lang}/${contextMenuNode.id}/`, '_blank');
    }
    hideContextMenu();
  });
  
  document.getElementById('context-highlight-connections')?.addEventListener('click', () => {
    if (contextMenuNode) {
      highlightConnections(contextMenuNode.id);
    }
    hideContextMenu();
  });
  
  // –ó–∞–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
  document.addEventListener('click', (e) => {
    const menu = document.getElementById('context-menu');
    if (menu && !menu.contains(e.target as Node)) {
      hideContextMenu();
    }
  });
  
  // –ó–∞–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –ø—Ä–∞–≤–æ–º –∫–ª–∏–∫–µ
  document.addEventListener('contextmenu', (e) => {
    const menu = document.getElementById('context-menu');
    if (menu && !menu.contains(e.target as Node)) {
      hideContextMenu();
    }
  });
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ View Transitions
  document.addEventListener('astro:page-load', () => {
    zoomControlsSetup = false;
    highlightedNodeId = null;
    init();
  });
  
  // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
  init();
</script>
