---
import Layout from '@/layouts/Layout.astro';
import Breadcrumbs from '@/components/ui/Breadcrumbs.astro';
import { SUPPORTED_LOCALES, type Locale, getLocalizedPath } from '@/utils/slugs';

interface Props {
  lang: Locale;
}

const { lang } = Astro.params as Props;

export function getStaticPaths() {
  return SUPPORTED_LOCALES.map(lang => ({ 
    params: { lang } 
  }));
}
---

<Layout 
  title="–ì—Ä–∞—Ñ –∑–Ω–∞–Ω–∏–π" 
  description="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–≤—è–∑–µ–π –º–µ–∂–¥—É –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏"
  lang={lang}
>
  <div class="max-w-7xl mx-auto">
    <Breadcrumbs title="–ì—Ä–∞—Ñ –∑–Ω–∞–Ω–∏–π" lang={lang} />
    <header class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-4xl font-bold">–ì—Ä–∞—Ñ –∑–Ω–∞–Ω–∏–π</h1>
        <a 
          href={getLocalizedPath('', lang)}
          class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 underline transition-colors"
          data-astro-prefetch
        >
          ‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é
        </a>
      </div>
      <p class="text-lg text-gray-600 dark:text-gray-400">
        –ò—Å—Å–ª–µ–¥—É–π—Ç–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ —Å–∞–π—Ç–∞
      </p>
    </header>
    
    <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
    <div class="mb-6 space-y-4">
      <!-- –ü–æ–∏—Å–∫ —É–∑–ª–æ–≤ -->
      <div class="flex items-center gap-2">
        <label for="search-nodes" class="text-sm font-medium text-gray-700 dark:text-gray-300">
          üîç –ü–æ–∏—Å–∫:
        </label>
        <input
          type="text"
          id="search-nodes"
          placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–∑–ª–∞..."
          class="flex-1 max-w-md border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:outline-none"
        />
        <button
          id="clear-search"
          class="px-3 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md transition-colors text-sm"
          style="display: none;"
        >
          ‚úï –û—á–∏—Å—Ç–∏—Ç—å
        </button>
      </div>
      
      <!-- –§–∏–ª—å—Ç—Ä—ã -->
      <div class="flex flex-wrap gap-4 items-center">
        <div class="flex items-center gap-2">
          <label for="filter-type" class="text-sm font-medium text-gray-700 dark:text-gray-300">
            –¢–∏–ø:
          </label>
          <select 
            id="filter-type"
            multiple
            size="4"
            class="border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500"
            style="min-width: 150px; max-height: 120px;"
          >
            <option value="blog">–ë–ª–æ–≥</option>
            <option value="cases">–ö–µ–π—Å—ã</option>
            <option value="services">–£—Å–ª—É–≥–∏</option>
            <option value="industries">–û—Ç—Ä–∞—Å–ª–∏</option>
          </select>
          <span class="text-xs text-gray-500 dark:text-gray-400">(Ctrl+Click)</span>
        </div>
        
        <div class="flex items-center gap-2">
          <label for="filter-tags" class="text-sm font-medium text-gray-700 dark:text-gray-300">
            –¢–µ–≥:
          </label>
          <select 
            id="filter-tags"
            multiple
            size="4"
            class="border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500"
            style="min-width: 150px; max-height: 120px;"
          >
            <option value="">–í—Å–µ —Ç–µ–≥–∏</option>
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ graph.nodes -->
          </select>
          <span class="text-xs text-gray-500 dark:text-gray-400">(Ctrl+Click)</span>
        </div>
        
        <div class="flex items-center gap-2">
          <label for="filter-link-type" class="text-sm font-medium text-gray-700 dark:text-gray-300">
            –¢–∏–ø —Å–≤—è–∑–∏:
          </label>
          <select 
            id="filter-link-type"
            multiple
            size="2"
            class="border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500"
            style="min-width: 150px;"
          >
            <option value="explicit">–Ø–≤–Ω—ã–µ —Å–≤—è–∑–∏</option>
            <option value="outbound">–ò—Å—Ö–æ–¥—è—â–∏–µ —Å—Å—ã–ª–∫–∏</option>
          </select>
        </div>
        
        <button
          id="reset-filters"
          class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md transition-colors text-sm"
        >
          –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        </button>
      </div>
    </div>
    
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∞ -->
    <div 
      id="graph-container" 
      class="border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 overflow-hidden relative"
      style="width: 100%; height: 600px;"
    ></div>
    
    <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è –≥—Ä–∞—Ñ–∞ -->
    <div class="mt-4 flex flex-wrap gap-2 items-center justify-center text-sm">
      <button
        id="zoom-in"
        class="px-3 py-1.5 bg-blue-600 dark:bg-blue-500 hover:bg-blue-700 dark:hover:bg-blue-600 text-white rounded-md transition-colors"
        title="–£–≤–µ–ª–∏—á–∏—Ç—å"
      >
        üîç+
      </button>
      <button
        id="zoom-out"
        class="px-3 py-1.5 bg-blue-600 dark:bg-blue-500 hover:bg-blue-700 dark:hover:bg-blue-600 text-white rounded-md transition-colors"
        title="–£–º–µ–Ω—å—à–∏—Ç—å"
      >
        üîç-
      </button>
      <button
        id="zoom-fit"
        class="px-3 py-1.5 bg-blue-600 dark:bg-blue-500 hover:bg-blue-700 dark:hover:bg-blue-600 text-white rounded-md transition-colors"
        title="–ü–æ–¥–æ–≥–Ω–∞—Ç—å –ø–æ–¥ —Ä–∞–∑–º–µ—Ä"
      >
        ‚õ∂ –ü–æ–¥–æ–≥–Ω–∞—Ç—å
      </button>
      <button
        id="zoom-reset"
        class="px-3 py-1.5 bg-gray-600 dark:bg-gray-500 hover:bg-gray-700 dark:hover:bg-gray-600 text-white rounded-md transition-colors"
        title="–°–±—Ä–æ—Å–∏—Ç—å zoom"
      >
        ‚Ü∫ –°–±—Ä–æ—Å–∏—Ç—å
      </button>
      <button
        id="nav-back"
        class="px-3 py-1.5 bg-gray-600 dark:bg-gray-500 hover:bg-gray-700 dark:hover:bg-gray-600 text-white rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        title="–ù–∞–∑–∞–¥"
        disabled
      >
        ‚Üê –ù–∞–∑–∞–¥
      </button>
      <button
        id="nav-forward"
        class="px-3 py-1.5 bg-gray-600 dark:bg-gray-500 hover:bg-gray-700 dark:hover:bg-gray-600 text-white rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        title="–í–ø–µ—Ä—ë–¥"
        disabled
      >
        –í–ø–µ—Ä—ë–¥ ‚Üí
      </button>
      <button
        id="export-image"
        class="px-3 py-1.5 bg-green-600 dark:bg-green-500 hover:bg-green-700 dark:hover:bg-green-600 text-white rounded-md transition-colors"
        title="–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
      >
        üì• –≠–∫—Å–ø–æ—Ä—Ç
      </button>
      <button
        id="export-json"
        class="px-3 py-1.5 bg-blue-600 dark:bg-blue-500 hover:bg-blue-700 dark:hover:bg-blue-600 text-white rounded-md transition-colors"
        title="–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∞ –≤ JSON"
      >
        üìÑ JSON
      </button>
      <div class="text-gray-600 dark:text-gray-400 ml-4">
        <span class="text-xs">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–ª–µ—Å–æ –º—ã—à–∏ –¥–ª—è zoom, –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è</span>
      </div>
    </div>
    
    <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (—Å–∫—Ä—ã—Ç–æ–µ) -->
    <div
      id="context-menu"
      class="hidden fixed bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg py-1 z-50"
      style="min-width: 150px;"
    >
      <button
        id="context-copy-node"
        class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm"
      >
        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —É–∑–ª–∞
      </button>
      <button
        id="context-open-new"
        class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm"
      >
        üîó –û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
      </button>
      <button
        id="context-highlight-connections"
        class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm"
      >
        ‚ú® –í—ã–¥–µ–ª–∏—Ç—å —Å–≤—è–∑–∏
      </button>
      <button
        id="context-select-incoming"
        class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm"
      >
        ‚Üê –í—ã–¥–µ–ª–∏—Ç—å –≤—Ö–æ–¥—è—â–∏–µ —Å–≤—è–∑–∏
      </button>
      <button
        id="context-select-outgoing"
        class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm"
      >
        ‚Üí –í—ã–¥–µ–ª–∏—Ç—å –∏—Å—Ö–æ–¥—è—â–∏–µ —Å–≤—è–∑–∏
      </button>
      <button
        id="context-select-all-edges"
        class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm"
      >
        ‚Üî –í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ —Å–≤—è–∑–∏
      </button>
    </div>
    
    <!-- –õ–µ–≥–µ–Ω–¥–∞ -->
    <div class="mt-6 flex flex-wrap gap-4 text-sm">
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-blue-500"></div>
        <span>–ë–ª–æ–≥</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-green-500"></div>
        <span>–ö–µ–π—Å—ã</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-yellow-500"></div>
        <span>–£—Å–ª—É–≥–∏</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-purple-500"></div>
        <span>–û—Ç—Ä–∞—Å–ª–∏</span>
      </div>
    </div>
  </div>
</Layout>

<script>
  import type { GraphNode, GraphEdge, GraphData } from '@/types/graph';
  import type { 
    ForceGraphInstance, 
    ForceLink, 
    ForceManyBody, 
    ForceCenter,
    ForceGraphLink 
  } from '@/types/force-graph';
  import { escapeHtml } from '@/utils/escape-html';
  import { GRAPH_CONSTANTS } from '@/utils/graph-constants';
  import { getGraphState } from '@/utils/graph-state';
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ DOM API
  if (typeof window === 'undefined') {
    throw new Error('This script must run in browser environment');
  }
  
  // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
  let ForceGraph: ((container: HTMLElement) => ForceGraphInstance) | null = null;
  let forceCenter: ForceCenter | null = null;
  let forceManyBody: (() => ForceManyBody) | null = null;
  let forceLink: ((links: ForceGraphLink[]) => ForceLink) | null = null;
  
  // –ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
  async function loadGraphLibraries() {
    if (!ForceGraph) {
      const forceGraphModule = await import('force-graph');
      ForceGraph = forceGraphModule.default as (container: HTMLElement) => ForceGraphInstance;
    }
    if (!forceCenter) {
      const d3ForceModule = await import('d3-force');
      forceCenter = d3ForceModule.forceCenter as ForceCenter;
      forceManyBody = (() => d3ForceModule.forceManyBody()) as () => ForceManyBody;
      forceLink = ((links: ForceGraphLink[]) => d3ForceModule.forceLink(links)) as (links: ForceGraphLink[]) => ForceLink;
    }
  }
  
  // –ò—Å—Ç–æ—Ä–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  class NavigationHistory {
    private history: string[] = [];
    private currentPosition: number = -1;
    
    addToHistory(nodeId: string) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–º —É–∑–ª–æ–º
      if (this.history[this.currentPosition] === nodeId) {
        return;
      }
      
      // –£–¥–∞–ª—è–µ–º —É–∑–µ–ª –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –µ—Å—Ç—å
      const index = this.history.indexOf(nodeId);
      if (index > -1) {
        this.history.splice(index, 1);
      }
      
      // –£–¥–∞–ª—è–µ–º –≤—Å–µ —É–∑–ª—ã –ø–æ—Å–ª–µ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ (–µ—Å–ª–∏ –º—ã –Ω–µ –≤ –∫–æ–Ω—Ü–µ)
      if (this.currentPosition < this.history.length - 1) {
        this.history = this.history.slice(0, this.currentPosition + 1);
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —É–∑–µ–ª
      this.history.push(nodeId);
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–ø–∏—Å–µ–π
      if (this.history.length > GRAPH_CONSTANTS.NAVIGATION_HISTORY_MAX) {
        this.history.shift();
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
      this.currentPosition = this.history.length - 1;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
      this.updateNavigationButtons();
    }
    
    getPrevious(): string | null {
      if (this.currentPosition > 0) {
        this.currentPosition--;
        this.updateNavigationButtons();
        return this.history[this.currentPosition];
      }
      return null;
    }
    
    getNext(): string | null {
      if (this.currentPosition < this.history.length - 1) {
        this.currentPosition++;
        this.updateNavigationButtons();
        return this.history[this.currentPosition];
      }
      return null;
    }
    
    hasPrevious(): boolean {
      return this.currentPosition > 0;
    }
    
    hasNext(): boolean {
      return this.currentPosition < this.history.length - 1;
    }
    
    updateNavigationButtons() {
      const backBtn = document.getElementById('nav-back') as HTMLButtonElement;
      const forwardBtn = document.getElementById('nav-forward') as HTMLButtonElement;
      
      if (backBtn) {
        backBtn.disabled = !this.hasPrevious();
      }
      if (forwardBtn) {
        forwardBtn.disabled = !this.hasNext();
      }
    }
  }
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–º–µ—Å—Ç–æ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
  const state = getGraphState();
  const navigationHistory = new NavigationHistory();
  const lang = document.documentElement.lang || 'ru';
  
  // –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞)
  let graph: ForceGraphInstance | null = null;
  let allData: GraphData | null = null;
  let highlightedNodeId: string | null = null;
  let contextMenuNode: GraphNode | null = null;
  let focusModeActive: boolean = false;
  let focusModeNodes: Set<string> = new Set();
  
  async function init() {
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
    if (initInProgress) {
      return;
    }
    initInProgress = true;
    
    try {
      // –ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
      await loadGraphLibraries();
      
      const { getGraphData } = await import('@/utils/graph-cache');
      allData = await getGraphData(lang);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      if (!allData || allData.nodes.length === 0) {
        showEmptyState();
        return;
      }
      
      // –ó–∞–ø–æ–ª–Ω–∏—Ç—å select —Å —Ç–µ–≥–∞–º–∏ (—É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã —á–µ—Ä–µ–∑ Set)
      const allTags = [...new Set(allData.nodes.flatMap((n) => n.tags || []))].sort();
      const tagsSelect = document.getElementById('filter-tags') as HTMLSelectElement;
      
      if (tagsSelect) {
        // –û—á–∏—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ü–∏–∏ (–∫—Ä–æ–º–µ "–í—Å–µ —Ç–µ–≥–∏" - –ø–µ—Ä–≤–∞—è –æ–ø—Ü–∏—è —Å index 0)
        while (tagsSelect.options.length > 1) {
          tagsSelect.remove(1);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥–∏, –ø—Ä–æ–≤–µ—Ä—è—è –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ value
        const existingValues = new Set<string>();
        allTags.forEach(tag => {
          if (!tag) return;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–≥ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω
          if (!existingValues.has(tag)) {
            existingValues.add(tag);
            const option = document.createElement('option');
            option.value = tag;
            option.textContent = tag;
            tagsSelect.appendChild(option);
          }
        });
      }
      
      renderGraph(allData, true);
    } catch (error) {
      if (import.meta.env.DEV) {
        console.error('Error loading graph data:', error);
      }
      showEmptyState();
    } finally {
      initInProgress = false;
    }
  }
  
  function showEmptyState() {
    const graphContainer = document.getElementById('graph-container');
    if (graphContainer) {
      // ‚ö†Ô∏è –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: innerHTML –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏ (–±–µ–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞)
      // escapeHtml() –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å—Ç–∞—Ç–∏—á–µ–Ω –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º
      // –ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å escapeHtml()
      graphContainer.innerHTML = `
        <div class="flex flex-col items-center justify-center h-96 text-center p-8">
          <svg class="w-24 h-24 text-gray-400 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
            –ì—Ä–∞—Ñ –∑–Ω–∞–Ω–∏–π –ø—É—Å—Ç
          </h3>
          <p class="text-gray-600 dark:text-gray-400 max-w-md">
            –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∞ –∑–Ω–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞.
          </p>
        </div>
      `;
    }
  }
  
  // Debounce timer –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
  let filterDebounceTimer: ReturnType<typeof setTimeout> | null = null;
  
  function applyFilters() {
    // –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
    if (filterDebounceTimer) {
      clearTimeout(filterDebounceTimer);
    }
    
    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä –¥–ª—è debounce
    filterDebounceTimer = setTimeout(() => {
      if (!allData) return;
      
      const typeSelect = document.getElementById('filter-type') as HTMLSelectElement;
      const tagSelect = document.getElementById('filter-tags') as HTMLSelectElement;
      const linkTypeSelect = document.getElementById('filter-link-type') as HTMLSelectElement;
      
      // –ü–æ–ª—É—á–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –∏—Å–∫–ª—é—á–∞—è –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
      const selectedTypes = Array.from(typeSelect.selectedOptions)
        .map(opt => opt.value)
        .filter(v => v !== '');
      const selectedTags = Array.from(tagSelect.selectedOptions)
        .map(opt => opt.value)
        .filter(v => v !== '');
      const selectedLinkTypes = Array.from(linkTypeSelect.selectedOptions)
        .map(opt => opt.value)
        .filter(v => v !== '');
      
      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —É–∑–ª–æ–≤
      const filteredNodes = allData.nodes.filter((n) => {
        const typeMatch = selectedTypes.length === 0 || selectedTypes.includes(n.type);
        const tagMatch = selectedTags.length === 0 || (n.tags && n.tags.some(tag => selectedTags.includes(tag)));
        return typeMatch && tagMatch;
      });
      
      const nodeIds = new Set(filteredNodes.map((n) => n.id));
      
      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä—ë–±–µ—Ä
      let filteredEdges = allData.edges.filter((e) => 
        nodeIds.has(e.from) && nodeIds.has(e.to)
      );
      
      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É —Å–≤—è–∑–∏
      if (selectedLinkTypes.length > 0) {
        filteredEdges = filteredEdges.filter((e) => 
          selectedLinkTypes.includes(e.source) // e.source —ç—Ç–æ 'explicit' –∏–ª–∏ 'outbound'
        );
      }
      
      // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤
      const totalNodes = allData.nodes.length;
      const filteredCount = filteredNodes.length;
      if (filteredCount < totalNodes) {
        showNotification(`–ü–æ–∫–∞–∑–∞–Ω–æ ${filteredCount} –∏–∑ ${totalNodes} —É–∑–ª–æ–≤`, 'success');
      }
      
      // –ü—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤—Å–µ–≥–¥–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ, –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
      renderGraph({ nodes: filteredNodes, edges: filteredEdges }, true, false);
    }, GRAPH_CONSTANTS.DEBOUNCE_FILTER_MS);
  }
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π —É–∑–ª–æ–≤
  function saveNodePositions() {
    if (!graph) return;
    const graphData = graph.graphData();
    if (graphData && 'nodes' in graphData) {
      const positions: Record<string, { x: number; y: number }> = {};
      (graphData.nodes as GraphNode[]).forEach(node => {
        if (node.x !== undefined && node.y !== undefined && !isNaN(node.x) && !isNaN(node.y)) {
          positions[node.id] = { x: node.x, y: node.y };
        }
      });
      try {
        localStorage.setItem(GRAPH_CONSTANTS.STORAGE_KEY_POSITIONS(lang), JSON.stringify(positions));
      } catch (e) {
        // –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ localStorage (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω)
        if (import.meta.env.DEV) {
          console.warn('Failed to save node positions:', e);
        }
      }
    }
  }
  
  function restoreNodePositions(width: number, height: number): Record<string, { x: number; y: number }> | null {
    try {
      const saved = localStorage.getItem(GRAPH_CONSTANTS.STORAGE_KEY_POSITIONS(lang));
      if (saved) {
        const positions = JSON.parse(saved);
        // –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏–∏ - –ø—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ –æ–Ω–∏ –≤ —Ä–∞–∑—É–º–Ω—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –≤ 5 —Ä–∞–∑ –±–æ–ª—å—à–µ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è —É—á—ë—Ç–∞ zoom/pan
        const maxX = width * GRAPH_CONSTANTS.POSITION_VALIDATION_MULTIPLIER;
        const maxY = height * GRAPH_CONSTANTS.POSITION_VALIDATION_MULTIPLIER;
        const minX = -maxX;
        const minY = -maxY;
        
        const validPositions: Record<string, { x: number; y: number }> = {};
        let hasValidPositions = false;
        
        for (const [nodeId, pos] of Object.entries(positions)) {
          if (pos && typeof pos === 'object' && 'x' in pos && 'y' in pos) {
            const x = pos.x as number;
            const y = pos.y as number;
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–∑–∏—Ü–∏—è –≤ —Ä–∞–∑—É–º–Ω—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö
            if (!isNaN(x) && !isNaN(y) && 
                x >= minX && x <= maxX && 
                y >= minY && y <= maxY) {
              validPositions[nodeId] = { x, y };
              hasValidPositions = true;
            }
          }
        }
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –≤–∞–ª–∏–¥–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
        return hasValidPositions ? validPositions : null;
      }
    } catch (e) {
      // –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
      if (import.meta.env.DEV) {
        console.warn('Failed to restore node positions:', e);
      }
    }
    return null;
  }
  
  function renderGraph(data: GraphData, autoFit: boolean = true, useSavedPositions: boolean = true) {
    const container = document.getElementById('graph-container');
    if (!container) return;
    
    // –£–Ω–∏—á—Ç–æ–∂–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ
    if (graph) {
      graph._destructor();
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º offsetWidth/offsetHeight –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –±–µ–∑ padding
    // –∏–ª–∏ clientWidth/clientHeight, –µ—Å–ª–∏ offsetWidth –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    const width = container.offsetWidth || container.clientWidth || GRAPH_CONSTANTS.DEFAULT_WIDTH;
    const height = container.offsetHeight || container.clientHeight || GRAPH_CONSTANTS.DEFAULT_HEIGHT;
    const margin = GRAPH_CONSTANTS.BOUNDING_BOX_MARGIN;
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    // –í force-graph –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å (0,0) –≤ –ª–µ–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
    // –¶–µ–Ω—Ç—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ (width/2, height/2)
    const centerX = width / 2;
    const centerY = height / 2;
    
    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ –≤ dev —Ä–µ–∂–∏–º–µ)
    if (import.meta.env.DEV) {
      console.log('Graph container:', { width, height, centerX, centerY });
      console.log('Graph data:', { nodes: data.nodes.length, edges: data.edges.length });
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
    if (data.nodes.length === 0) {
      if (import.meta.env.DEV) {
        console.warn('No nodes to display');
      }
      return;
    }
    
    // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è, –±—ã–ª –ª–∏ –≤—ã–∑–≤–∞–Ω zoomToFit
    let zoomToFitCalled = false;
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å edges –≤ links –¥–ª—è force-graph
    // force-graph –æ–∂–∏–¥–∞–µ—Ç, —á—Ç–æ source –∏ target –±—É–¥—É—Ç —Å—Ç—Ä–æ–∫–∞–º–∏ (ID) –∏–ª–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏ —É–∑–ª–æ–≤
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫–∏ (ID) –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã - force-graph —Å–∞–º –Ω–∞–π–¥—ë—Ç —É–∑–ª—ã
    const links = data.edges.map((e) => ({
      source: e.from, // ID —É–∑–ª–∞-–∏—Å—Ç–æ—á–Ω–∏–∫–∞
      target: e.to,   // ID —É–∑–ª–∞-—Ü–µ–ª–∏
      sourceType: e.source, // 'explicit' | 'outbound' - –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
    }));
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã —É–∑–ª–æ–≤ –¥–ª—è —É—á—ë—Ç–∞ –≤ –≥—Ä–∞–Ω–∏—Ü–∞—Ö
    const nodeSizes = new Map<string, number>();
    data.nodes.forEach((node) => {
      const connections = data.edges.filter((e) => 
        e.from === node.id || e.to === node.id
      ).length;
      const size = Math.max(
        GRAPH_CONSTANTS.NODE_SIZE_MIN, 
        Math.min(GRAPH_CONSTANTS.NODE_SIZE_MAX, connections * GRAPH_CONSTANTS.NODE_SIZE_CONNECTION_FACTOR)
      );
      nodeSizes.set(node.id, size);
    });
    
    // –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å–∏–ª–∞ –¥–ª—è –º—è–≥–∫–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü
    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ —É–∑–ª–æ–≤, –∫–æ–≥–¥–∞ –æ–Ω–∏ –≤—ã—Ö–æ–¥—è—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã
    // –≠—Ç–æ –Ω–µ —Ö–∞—Ä–¥–∫–æ–¥ - –º—ã –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏, –∞ —Ç–æ–ª—å–∫–æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Å–∫–æ—Ä–æ—Å—Ç–∏
    const boundingBoxForce = () => {
      let nodes: Array<GraphNode & { x?: number; y?: number; vx?: number; vy?: number }>;
      
      const force = (alpha: number) => {
        nodes.forEach((node) => {
          const nodeSize = nodeSizes.get(node.id) || 10;
          const xMin = margin + nodeSize;
          const xMax = width - margin - nodeSize;
          const yMin = margin + nodeSize;
          const yMax = height - margin - nodeSize;
          
          // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å, –µ—Å–ª–∏ —É–∑–µ–ª –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: —Å–∏–ª—å–Ω–µ–µ –¥–ª—è —É–∑–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –≤—ã—à–ª–∏ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
          const overshootX = node.x! < xMin ? xMin - node.x! : (node.x! > xMax ? node.x! - xMax : 0);
          const overshootY = node.y! < yMin ? yMin - node.y! : (node.y! > yMax ? node.y! - yMax : 0);
          
          // –ï—Å–ª–∏ —É–∑–µ–ª —É–∂–µ –∑–∞ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ —Å–∏–ª—å–Ω—É—é –∫–æ—Ä—Ä–µ–∫—Ü–∏—é
          const correctionStrength = (overshootX > 0 || overshootY > 0) 
            ? GRAPH_CONSTANTS.BOUNDING_CORRECTION_STRENGTH_STRONG 
            : GRAPH_CONSTANTS.BOUNDING_CORRECTION_STRENGTH_NORMAL;
          
          if (node.x! < xMin) {
            node.vx = (node.vx || 0) + (xMin - node.x!) * correctionStrength;
            // –ï—Å–ª–∏ —É–∑–µ–ª —Å–∏–ª—å–Ω–æ –∑–∞ –≥—Ä–∞–Ω–∏—Ü–µ–π, —Ç–∞–∫–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é
            if (overshootX > GRAPH_CONSTANTS.OVERSHOOT_THRESHOLD_PX) {
              node.x = xMin;
            }
          }
          if (node.x! > xMax) {
            node.vx = (node.vx || 0) + (xMax - node.x!) * correctionStrength;
            if (overshootX > GRAPH_CONSTANTS.OVERSHOOT_THRESHOLD_PX) {
              node.x = xMax;
            }
          }
          if (node.y! < yMin) {
            node.vy = (node.vy || 0) + (yMin - node.y!) * correctionStrength;
            if (overshootY > GRAPH_CONSTANTS.OVERSHOOT_THRESHOLD_PX) {
              node.y = yMin;
            }
          }
          if (node.y! > yMax) {
            node.vy = (node.vy || 0) + (yMax - node.y!) * correctionStrength;
            if (overshootY > GRAPH_CONSTANTS.OVERSHOOT_THRESHOLD_PX) {
              node.y = yMax;
            }
          }
        });
      };
      
      force.initialize = (n: Array<GraphNode & { x?: number; y?: number; vx?: number; vy?: number }>) => {
        nodes = n;
      };
      
      return force;
    };
    
    // –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å–∏–ª–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∞
    // –í—ã–∑—ã–≤–∞–µ—Ç zoomToFit –ø–æ—Å–ª–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ (–∫–æ–≥–¥–∞ alpha —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–º)
    const stabilizationTracker = () => {
      let nodes: Array<GraphNode & { x?: number; y?: number; vx?: number; vy?: number }>;
      let lastAlpha = 1;
      let stableTicks = 0;
      
      const force = (alpha: number) => {
        // –ï—Å–ª–∏ alpha –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π, –≥—Ä–∞—Ñ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è
        // –ù–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∏–∫–æ–≤ –ø–æ–¥—Ä—è–¥, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è
        if (alpha < GRAPH_CONSTANTS.STABILIZATION_ALPHA_THRESHOLD && 
            lastAlpha < GRAPH_CONSTANTS.STABILIZATION_ALPHA_THRESHOLD) {
          stableTicks++;
          // –ü–æ—Å–ª–µ —Ç—Ä–µ–±—É–µ–º–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö —Ç–∏–∫–æ–≤ –≤—ã–∑—ã–≤–∞–µ–º zoomToFit
          if (stableTicks >= GRAPH_CONSTANTS.STABLE_TICKS_REQUIRED && 
              autoFit && !zoomToFitCalled && graph) {
            zoomToFitCalled = true;
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ –≤—Å–µ —É–∑–ª—ã –Ω–∞ –º–µ—Å—Ç–µ
            setTimeout(() => {
              if (graph) {
                graph.zoomToFit(GRAPH_CONSTANTS.ZOOM_FIT_DURATION_MS);
              }
            }, GRAPH_CONSTANTS.STABILIZATION_CHECK_DELAY_MS);
          }
        } else {
          stableTicks = 0;
        }
        lastAlpha = alpha;
      };
      
      force.initialize = (n: Array<GraphNode & { x?: number; y?: number; vx?: number; vy?: number }>) => {
        nodes = n;
        lastAlpha = 1;
        stableTicks = 0;
        zoomToFitCalled = false;
      };
      
      return force;
    };
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —É–∑–ª–æ–≤ –ü–ï–†–ï–î —Å–æ–∑–¥–∞–Ω–∏–µ–º –≥—Ä–∞—Ñ–∞
    // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø–æ–∑–∏—Ü–∏–∏ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    
    // –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ localStorage
    // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ useSavedPositions = true (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true –¥–ª—è –æ–±—ã—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏)
    const savedPositions = useSavedPositions ? restoreNodePositions(width, height) : null;
    
    // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
    let usedSavedPositions = false;
    
    data.nodes.forEach((node, index: number) => {
      // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –ò —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—ë
      if (useSavedPositions && savedPositions && savedPositions[node.id]) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
        const savedX = savedPositions[node.id].x;
        const savedY = savedPositions[node.id].y;
        const marginCheck = GRAPH_CONSTANTS.BOUNDING_POSITION_MARGIN_CHECK;
        
        if (savedX >= -marginCheck && savedX <= width + marginCheck &&
            savedY >= -marginCheck && savedY <= height + marginCheck) {
          node.x = savedX;
          node.y = savedY;
          usedSavedPositions = true;
        } else {
          // –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –≤–Ω–µ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
          const angle = (index / data.nodes.length) * Math.PI * 2;
          const radius = Math.min(width, height) * GRAPH_CONSTANTS.NODE_POSITION_RADIUS_FACTOR;
          node.x = centerX + Math.cos(angle) * radius;
          node.y = centerY + Math.sin(angle) * radius;
        }
      } else {
        // –í—Å–µ–≥–¥–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —É–∑–ª—ã –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏–ª–∏ –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
        const angle = (index / data.nodes.length) * Math.PI * 2;
        const radius = Math.min(width, height) * GRAPH_CONSTANTS.NODE_POSITION_RADIUS_FACTOR;
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –≤ —Ü–µ–Ω—Ç—Ä–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        // –í force-graph –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å (0,0) –≤ –ª–µ–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
        // –¶–µ–Ω—Ç—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ (width/2, height/2)
        node.x = centerX + Math.cos(angle) * radius;
        node.y = centerY + Math.sin(angle) * radius;
        
        // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ø–µ—Ä–≤—ã—Ö –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É–∑–ª–æ–≤
        if (import.meta.env.DEV && index < 3) {
          console.log(`Node ${index} initial position:`, { 
            x: node.x, 
            y: node.y, 
            centerX, 
            centerY, 
            width, 
            height 
          });
        }
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤ 0
      node.vx = 0;
      node.vy = 0;
    });
    
    // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏, —Å—Ä–∞–∑—É –≤—ã–∑—ã–≤–∞–µ–º zoomToFit
    // —á—Ç–æ–±—ã –≥—Ä–∞—Ñ –±—ã–ª –≤–∏–¥–µ–Ω –≤ –æ–∫–Ω–µ
    const shouldFitImmediately = usedSavedPositions;
    
    // –°–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ
    // force-graph –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏ –≤ links, –Ω–æ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã —É–∑–ª–æ–≤
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º links —Ç–∞–∫, —á—Ç–æ–±—ã source –∏ target –±—ã–ª–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏ —É–∑–ª–æ–≤
    const linksWithNodes: ForceGraphLink[] = links.map(link => {
      const sourceNode = data.nodes.find(n => n.id === link.source);
      const targetNode = data.nodes.find(n => n.id === link.target);
      
      if (!sourceNode || !targetNode) {
        if (import.meta.env.DEV) {
          console.warn('Link references missing node:', { source: link.source, target: link.target });
        }
        return null;
      }
      
      return {
        source: sourceNode,
        target: targetNode,
        sourceType: link.sourceType,
      };
    }).filter((link): link is ForceGraphLink => link !== null);
    
    if (import.meta.env.DEV) {
      console.log('Links with nodes:', linksWithNodes.length, 'out of', links.length);
    }
    
    graph = ForceGraph()(container)
      .graphData({ nodes: data.nodes, links: linksWithNodes })
      .width(width)
      .height(height)
      .nodeLabel((n: GraphNode) => n.title)
      .nodeColor((n: GraphNode) => {
        return GRAPH_CONSTANTS.NODE_COLORS[n.type] || GRAPH_CONSTANTS.NODE_COLORS.default;
      })
      .nodeVal((n: GraphNode) => nodeSizes.get(n.id) || 10)
      .linkWidth((link: ForceGraphLink) => {
        return link.sourceType === 'explicit' 
          ? GRAPH_CONSTANTS.LINK_WIDTH.explicit 
          : GRAPH_CONSTANTS.LINK_WIDTH.outbound;
      })
      .linkColor((link: ForceGraphLink) => {
        return link.sourceType === 'explicit'
          ? GRAPH_CONSTANTS.LINK_COLORS.explicit
          : GRAPH_CONSTANTS.LINK_COLORS.outbound;
      })
      .linkDirectionalArrowLength(GRAPH_CONSTANTS.LINK_ARROW_LENGTH)
      .linkDirectionalArrowRelPos(GRAPH_CONSTANTS.LINK_ARROW_REL_POS)
      .d3Force('center', forceCenter(
        width * GRAPH_CONSTANTS.FORCE_CENTER_X, 
        height * GRAPH_CONSTANTS.FORCE_CENTER_Y
      ))
      .d3Force('charge', forceManyBody().strength(GRAPH_CONSTANTS.FORCE_CHARGE_STRENGTH))
      .d3Force('link', forceLink(linksWithNodes).id((d: GraphNode | string) => {
        // d - —ç—Ç–æ –æ–±—ä–µ–∫—Ç —É–∑–ª–∞, –∏–∑–≤–ª–µ–∫–∞–µ–º id
        if (d && typeof d === 'object' && 'id' in d) return d.id;
        return String(d);
      }).distance(GRAPH_CONSTANTS.FORCE_LINK_DISTANCE))
      .d3Force('boundingBox', boundingBoxForce())
      .d3Force('stabilizationTracker', stabilizationTracker())
      // Zoom –∏ pan –∫–æ–Ω—Ç—Ä–æ–ª—ã (force-graph –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ)
      .enableZoomInteraction(true)
      .enablePanInteraction(true)
      .cooldownTicks(GRAPH_CONSTANTS.FORCE_COOLDOWN_TICKS)
      .onNodeClick((node: GraphNode) => {
        if (typeof window !== 'undefined' && node) {
          // –î–æ–±–∞–≤–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
          navigationHistory.addToHistory(node.id);
          
          const url = `/${lang}/${node.id}/`;
          window.location.href = url;
        }
      })
      .onNodeHover((node: GraphNode | null) => {
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        if (node) {
          container.style.cursor = 'pointer';
          highlightConnections(node.id);
        } else {
          container.style.cursor = 'default';
          clearHighlight();
        }
      })
      .onNodeRightClick((node: GraphNode, event: MouseEvent) => {
        // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –ø—Ä–∞–≤–æ–º –∫–ª–∏–∫–µ
        event.preventDefault();
        contextMenuNode = node;
        showContextMenu(event.clientX, event.clientY);
      })
      .onLinkHover((link: ForceGraphLink | null) => {
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ä—ë–±–µ—Ä –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        if (link) {
          container.style.cursor = 'pointer';
        }
      });
    
    // –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ —É–∑–ª–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –±—ã–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
    // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø–æ–∑–∏—Ü–∏–∏ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ force-graph
    if (!usedSavedPositions) {
      // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –≥—Ä–∞—Ñ —É—Å–ø–µ–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è
      setTimeout(() => {
        if (graph) {
          const graphData = graph.graphData();
          if (graphData && 'nodes' in graphData) {
            const nodes = graphData.nodes as GraphNode[];
            nodes.forEach((node, index) => {
              if (node.x === undefined || node.y === undefined || 
                  isNaN(node.x) || isNaN(node.y) ||
                  node.x === 0 || node.y === 0) {
                // –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–ª–∏ —Ä–∞–≤–Ω–∞ 0, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ—ë –≤ —Ü–µ–Ω—Ç—Ä
                const angle = (index / nodes.length) * Math.PI * 2;
                const radius = Math.min(width, height) * GRAPH_CONSTANTS.NODE_POSITION_RADIUS_FACTOR;
                node.x = centerX + Math.cos(angle) * radius;
                node.y = centerY + Math.sin(angle) * radius;
                node.vx = 0;
                node.vy = 0;
              }
            });
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∞ —Å –Ω–æ–≤—ã–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏
            graph.graphData({ nodes, links: linksWithNodes });
          }
        }
      }, 10);
    }
    
    // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å zoom –∫–æ–Ω—Ç—Ä–æ–ª—ã –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∞
    setupZoomControls();
    
    // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏, —Å—Ä–∞–∑—É –≤—ã–∑—ã–≤–∞–µ–º zoomToFit
    // —á—Ç–æ–±—ã –≥—Ä–∞—Ñ –±—ã–ª –≤–∏–¥–µ–Ω –≤ –æ–∫–Ω–µ (–±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏)
    if (shouldFitImmediately && autoFit && graph) {
      // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –≥—Ä–∞—Ñ —É—Å–ø–µ–ª –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è
      setTimeout(() => {
        if (graph) {
          graph.zoomToFit(GRAPH_CONSTANTS.ZOOM_FIT_DURATION_MS);
          zoomToFitCalled = true; // –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ —É–∂–µ –≤—ã–∑–≤–∞–ª–∏, —á—Ç–æ–±—ã stabilizationTracker –Ω–µ –≤—ã–∑—ã–≤–∞–ª –ø–æ–≤—Ç–æ—Ä–Ω–æ
        }
      }, GRAPH_CONSTANTS.ZOOM_FIT_DELAY_MS);
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ–∑–∏—Ü–∏–∏ —É–∑–ª–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ (debounced)
    let savePositionsTimer: ReturnType<typeof setTimeout> | null = null;
    const originalGraphData = graph.graphData();
    if (originalGraphData && 'nodes' in originalGraphData) {
      // –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –ø–æ—Å–ª–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
      const checkAndSave = () => {
        if (graph) {
          const currentData = graph.graphData();
          if (currentData && 'nodes' in currentData) {
            const nodes = currentData.nodes as GraphNode[];
            // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —É–∑–ª—ã –∏–º–µ—é—Ç –≤–∞–ª–∏–¥–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
            const hasValidPositions = nodes.some(n => n.x !== undefined && n.y !== undefined && !isNaN(n.x) && !isNaN(n.y));
            if (hasValidPositions) {
              if (savePositionsTimer) clearTimeout(savePositionsTimer);
              savePositionsTimer = setTimeout(() => {
                saveNodePositions();
              }, GRAPH_CONSTANTS.SAVE_POSITIONS_DELAY_MS);
            }
          }
        }
      };
      
      // –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–∏–º—É–ª—è—Ü–∏–∏
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
      const saveInterval = setInterval(() => {
        if (graph) {
          const currentData = graph.graphData();
          if (currentData && 'nodes' in currentData) {
            const nodes = currentData.nodes as GraphNode[];
            const hasValidPositions = nodes.some(n => n.x !== undefined && n.y !== undefined);
            if (hasValidPositions) {
              checkAndSave();
            }
          }
        }
      }, GRAPH_CONSTANTS.SAVE_POSITIONS_CHECK_INTERVAL_MS);
      
      // –û—á–∏—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∞
      const originalDestructor = graph._destructor;
      graph._destructor = function() {
        clearInterval(saveInterval);
        if (savePositionsTimer) clearTimeout(savePositionsTimer);
        return originalDestructor.call(this);
      };
    }
    
    // Fallback: –µ—Å–ª–∏ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã, –≤—ã–∑—ã–≤–∞–µ–º zoomToFit –≤—Ä—É—á–Ω—É—é
    if (autoFit) {
      setTimeout(() => {
        if (graph && !zoomToFitCalled) {
          zoomToFitCalled = true;
          graph.zoomToFit(GRAPH_CONSTANTS.ZOOM_FIT_DURATION_MS);
        }
      }, GRAPH_CONSTANTS.ZOOM_FIT_FALLBACK_MS);
    }
  }
  
  function resetFilters() {
    // –û—á–∏—Å—Ç–∏—Ç—å debounce timer –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterDebounceTimer) {
      clearTimeout(filterDebounceTimer);
      filterDebounceTimer = null;
    }
    
    const typeSelect = document.getElementById('filter-type') as HTMLSelectElement;
    const tagSelect = document.getElementById('filter-tags') as HTMLSelectElement;
    const linkTypeSelect = document.getElementById('filter-link-type') as HTMLSelectElement;
    
    // –°–±—Ä–æ—Å–∏—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä
    Array.from(typeSelect.options).forEach(opt => opt.selected = false);
    Array.from(tagSelect.options).forEach(opt => opt.selected = false);
    Array.from(linkTypeSelect.options).forEach(opt => opt.selected = false);
    
    if (allData) {
      // –ü—Ä–∏ —Å–±—Ä–æ—Å–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
      // –í—Å–µ–≥–¥–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ –∑–∞–Ω–æ–≤–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      renderGraph(allData, true, false);
    }
  }
  
  // –ü–æ–∏—Å–∫ —É–∑–ª–æ–≤
  function searchNodes(searchText: string) {
    if (!allData || !graph) return;
    
    const query = searchText.toLowerCase().trim();
    if (!query) {
      clearSearch();
      return;
    }
    
    // –ù–∞–π—Ç–∏ —É–∑–ª—ã, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
    const matchingNodes = allData.nodes.filter(node => 
      node.title.toLowerCase().includes(query) ||
      node.id.toLowerCase().includes(query) ||
      (node.tags && node.tags.some(tag => tag.toLowerCase().includes(query)))
    );
    
    if (matchingNodes.length > 0) {
      // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ø–µ—Ä–≤–æ–º –Ω–∞–π–¥–µ–Ω–Ω–æ–º —É–∑–ª–µ
      const firstNode = matchingNodes[0];
      const graphData = graph.graphData();
      if (graphData && 'nodes' in graphData && Array.isArray(graphData.nodes)) {
        const nodeObj = (graphData.nodes as GraphNode[]).find((n: GraphNode) => n.id === firstNode.id);
        
        if (nodeObj && 'x' in nodeObj && 'y' in nodeObj && nodeObj.x !== undefined && nodeObj.y !== undefined) {
          graph.centerAt(nodeObj.x, nodeObj.y, 1000);
          graph.zoomToFit(GRAPH_CONSTANTS.ZOOM_FIT_DURATION_MS, 20);
          
          // –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É–∑–ª—ã
          const foundNodeIds = matchingNodes.map(n => n.id);
          highlightSearchResults(foundNodeIds);
          
          // –ï—Å–ª–∏ —Ä–µ–∂–∏–º —Ñ–æ–∫—É—Å–∞ –∞–∫—Ç–∏–≤–µ–Ω, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É–∑–ª—ã –≤ —Ñ–æ–∫—É—Å
          if (focusModeActive) {
            setFocusNodes(foundNodeIds);
          }
        }
      }
    } else {
      clearSearch();
      showNotification('–£–∑–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning');
    }
  }
  
  function highlightSearchResults(nodeIds: string[]) {
    if (!graph) return;
    
    // –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É–∑–ª–æ–≤ —á–µ—Ä–µ–∑ nodeVal
    const originalNodeVal = graph.nodeVal();
    graph.nodeVal((node: GraphNode) => {
      const baseSize = typeof originalNodeVal === 'function' ? originalNodeVal(node) : 10;
      return nodeIds.includes(node.id) ? baseSize * 1.5 : baseSize;
    });
    
    // –ò–∑–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É–∑–ª–æ–≤
    const originalNodeColor = graph.nodeColor();
    graph.nodeColor((node: GraphNode) => {
      if (nodeIds.includes(node.id)) {
        return '#fbbf24'; // –ñ—ë–ª—Ç—ã–π –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É–∑–ª–æ–≤
      }
      // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Ü–≤–µ—Ç–∞
      if (typeof originalNodeColor === 'function') {
        return originalNodeColor(node);
      }
      // –í–µ—Ä–Ω—É—Ç—å –æ–±—ã—á–Ω—ã–µ —Ü–≤–µ—Ç–∞
      return getDefaultNodeColor(node);
    });
  }
  
  function clearSearch() {
    if (!graph || !allData) return;
    
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±—ã—á–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã —É–∑–ª–æ–≤
    const nodeSizes = new Map<string, number>();
    allData.nodes.forEach((node) => {
      const connections = allData.edges.filter((e) => 
        e.from === node.id || e.to === node.id
      ).length;
      const size = Math.max(5, Math.min(20, connections * 2));
      nodeSizes.set(node.id, size);
    });
    
    graph.nodeVal((n: GraphNode) => nodeSizes.get(n.id) || 10);
    
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±—ã—á–Ω—ã–µ —Ü–≤–µ—Ç–∞
    graph.nodeColor((n: GraphNode) => getDefaultNodeColor(n));
  }
  
  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤
  function highlightConnections(nodeId: string) {
    if (!graph || !allData || highlightedNodeId === nodeId) return;
    
    highlightedNodeId = nodeId;
    const connectedNodeIds = new Set<string>([nodeId]);
    
    // –ù–∞–π—Ç–∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —É–∑–ª—ã
    allData.edges.forEach(edge => {
      if (edge.from === nodeId) connectedNodeIds.add(edge.to);
      if (edge.to === nodeId) connectedNodeIds.add(edge.from);
    });
    
    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞
    const originalNodeColor = graph.nodeColor();
    const originalLinkColor = graph.linkColor();
    
    // –ò–∑–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤ (–∑–∞—Ç–µ–º–Ω–∏—Ç—å)
    graph.nodeColor((node: GraphNode) => {
      const baseColor = typeof originalNodeColor === 'function' ? originalNodeColor(node) : getDefaultNodeColor(node);
      if (connectedNodeIds.has(node.id)) {
        return baseColor; // –û—Å—Ç–∞–≤–∏—Ç—å —è—Ä–∫–∏–º
      }
      // –ó–∞—Ç–µ–º–Ω–∏—Ç—å –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ —É–∑–ª—ã (–¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ rgba)
      return addOpacityToColor(baseColor, 0.3);
    });
    
    // –ò–∑–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç —Ä—ë–±–µ—Ä
    graph.linkColor((link: ForceGraphLink) => {
      const sourceId = typeof link.source === 'string' ? link.source : link.source?.id;
      const targetId = typeof link.target === 'string' ? link.target : link.target?.id;
      const isConnected = sourceId === nodeId || targetId === nodeId;
      
      if (isConnected) {
        const baseColor = typeof originalLinkColor === 'function' ? originalLinkColor(link) : 'rgba(96, 165, 250, 0.8)';
        return baseColor.replace('0.8', '1'); // –£–±—Ä–∞—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö
      }
      // –ó–∞—Ç–µ–º–Ω–∏—Ç—å –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ä—ë–±—Ä–∞
      return 'rgba(148, 163, 184, 0.2)';
    });
  }
  
  function clearHighlight() {
    if (!graph || highlightedNodeId === null) return;
    
    highlightedNodeId = null;
    
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±—ã—á–Ω—ã–µ —Ü–≤–µ—Ç–∞ —É–∑–ª–æ–≤
    if (focusModeActive && focusModeNodes.size > 0) {
      // –ï—Å–ª–∏ —Ä–µ–∂–∏–º —Ñ–æ–∫—É—Å–∞ –∞–∫—Ç–∏–≤–µ–Ω, –ø—Ä–∏–º–µ–Ω–∏—Ç—å –µ–≥–æ
      applyFocusMode();
    } else {
      graph.nodeColor((n: GraphNode) => getDefaultNodeColor(n));
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±—ã—á–Ω—ã–µ —Ü–≤–µ—Ç–∞ —Ä—ë–±–µ—Ä
    graph.linkColor((link: ForceGraphLink) => {
      if (link.sourceType === 'explicit') {
        return 'rgba(96, 165, 250, 0.8)';
      } else {
        return 'rgba(148, 163, 184, 0.8)';
      }
    });
  }
  
  // –†–µ–∂–∏–º —Ñ–æ–∫—É—Å–∞
  function toggleFocusMode() {
    focusModeActive = !focusModeActive;
    const focusBtn = document.getElementById('focus-mode') as HTMLButtonElement;
    
    if (focusModeActive) {
      // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º —Ñ–æ–∫—É—Å–∞
      // –§–æ–∫—É—Å –Ω–∞ —É–∑–ª–∞—Ö, –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫, –∏–ª–∏ –Ω–∞ –≤—Å–µ—Ö –≤–∏–¥–∏–º—ã—Ö
      if (focusModeNodes.size === 0 && allData) {
        // –ï—Å–ª–∏ –Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ –≤–∏–¥–∏–º—ã–µ
        const graphData = graph.graphData();
        if (graphData && 'nodes' in graphData && Array.isArray(graphData.nodes)) {
          focusModeNodes = new Set((graphData.nodes as GraphNode[]).map((n: GraphNode) => n.id));
        }
      }
      applyFocusMode();
      focusBtn?.classList.add('ring-2', 'ring-purple-400');
    } else {
      // –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º —Ñ–æ–∫—É—Å–∞
      focusModeNodes.clear();
      if (graph) {
        graph.nodeColor((n: GraphNode) => getDefaultNodeColor(n));
      }
      focusBtn?.classList.remove('ring-2', 'ring-purple-400');
    }
  }
  
  function applyFocusMode() {
    if (!graph || !allData || focusModeNodes.size === 0) return;
    
    const originalNodeColor = graph.nodeColor();
    graph.nodeColor((node: GraphNode) => {
      const baseColor = typeof originalNodeColor === 'function' ? originalNodeColor(node) : getDefaultNodeColor(node);
      if (focusModeNodes.has(node.id)) {
        return baseColor; // –û—Å—Ç–∞–≤–∏—Ç—å —è—Ä–∫–∏–º
      }
      // –ó–∞—Ç–µ–º–Ω–∏—Ç—å —É–∑–ª—ã –Ω–µ –≤ —Ñ–æ–∫—É—Å–µ
      return addOpacityToColor(baseColor, 0.15);
    });
  }
  
  function setFocusNodes(nodeIds: string[]) {
    focusModeNodes = new Set(nodeIds);
    if (focusModeActive) {
      applyFocusMode();
    }
  }
  
  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —É–∑–ª–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  function getDefaultNodeColor(node: GraphNode): string {
    const colors: Record<GraphNode['type'], string> = {
      blog: '#3b82f6',
      cases: '#10b981',
      services: '#f59e0b',
      industries: '#8b5cf6',
    };
    return colors[node.type] || '#6b7280';
  }
  
  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –∫ —Ü–≤–µ—Ç—É
  function addOpacityToColor(color: string, opacity: number): string {
    // –ï—Å–ª–∏ —Ü–≤–µ—Ç —É–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ rgba, –∑–∞–º–µ–Ω–∏—Ç—å opacity
    if (color.startsWith('rgba(')) {
      return color.replace(/[\d.]+\)$/, `${opacity})`);
    }
    // –ï—Å–ª–∏ —Ü–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ hex, –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ rgba
    if (color.startsWith('#')) {
      const r = parseInt(color.slice(1, 3), 16);
      const g = parseInt(color.slice(3, 5), 16);
      const b = parseInt(color.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${opacity})`;
    }
    // –ï—Å–ª–∏ —Ü–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ rgb, –¥–æ–±–∞–≤–∏—Ç—å alpha
    if (color.startsWith('rgb(')) {
      return color.replace('rgb(', 'rgba(').replace(')', `, ${opacity})`);
    }
    // Fallback: –≤–µ—Ä–Ω—É—Ç—å —Ü–≤–µ—Ç –∫–∞–∫ –µ—Å—Ç—å
    return color;
  }
  
  // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
  function showContextMenu(x: number, y: number) {
    const menu = document.getElementById('context-menu');
    if (!menu || !contextMenuNode) return;
    
    menu.style.left = `${x}px`;
    menu.style.top = `${y}px`;
    menu.classList.remove('hidden');
  }
  
  function hideContextMenu() {
    const menu = document.getElementById('context-menu');
    if (menu) {
      menu.classList.add('hidden');
    }
  }
  
  // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∞
  function showExportModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.id = 'export-modal';
    
    const modalContent = document.createElement('div');
    modalContent.className = 'bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl';
    
    let format: 'png' | 'svg' = 'png';
    let pixelRatio = 2;
    let theme: 'light' | 'dark' = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    let watermark = false;
    let privacyMode = false;
    let transparentBg = false;
    
    // ‚ö†Ô∏è –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: innerHTML –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏ (–±–µ–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞)
    // escapeHtml() –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å—Ç–∞—Ç–∏—á–µ–Ω –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º
    // –ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å escapeHtml()
    modalContent.innerHTML = `
      <div class="mb-4">
        <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞</h2>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            –§–æ—Ä–º–∞—Ç:
          </label>
          <select id="export-format" class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
            <option value="png">PNG</option>
            <option value="svg">SVG</option>
          </select>
        </div>
        
        <div id="pixel-ratio-setting" class="mb-4">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            –ö–∞—á–µ—Å—Ç–≤–æ (pixel ratio): <span id="pixel-ratio-value">${escapeHtml(String(pixelRatio))}</span>
          </label>
          <input type="range" id="pixel-ratio-slider" min="0.5" max="5" step="0.1" value="${pixelRatio}" class="w-full">
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            –¢–µ–º–∞:
          </label>
          <select id="export-theme" class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
            <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
            <option value="dark">–¢—ë–º–Ω–∞—è</option>
          </select>
        </div>
        
        <div class="mb-4">
          <label class="flex items-center text-sm text-gray-700 dark:text-gray-300">
            <input type="checkbox" id="export-watermark" class="mr-2">
            –î–æ–±–∞–≤–∏—Ç—å watermark
          </label>
        </div>
        
        <div class="mb-4">
          <label class="flex items-center text-sm text-gray-700 dark:text-gray-300">
            <input type="checkbox" id="export-privacy" class="mr-2">
            –†–µ–∂–∏–º –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ (–∑–∞—Ç–µ–º–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç)
          </label>
        </div>
        
        <div id="transparent-bg-setting" class="mb-4">
          <label class="flex items-center text-sm text-gray-700 dark:text-gray-300">
            <input type="checkbox" id="export-transparent" class="mr-2">
            –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω
          </label>
        </div>
        
        <div class="flex gap-2 justify-end">
          <button id="export-cancel" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md transition-colors">
            –û—Ç–º–µ–Ω–∞
          </button>
          <button id="export-save" class="px-4 py-2 bg-green-600 dark:bg-green-500 hover:bg-green-700 dark:hover:bg-green-600 text-white rounded-md transition-colors">
            –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
          </button>
        </div>
      </div>
    `;
    
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    const formatSelect = modalContent.querySelector('#export-format') as HTMLSelectElement;
    const pixelRatioSlider = modalContent.querySelector('#pixel-ratio-slider') as HTMLInputElement;
    const pixelRatioValue = modalContent.querySelector('#pixel-ratio-value') as HTMLElement;
    const pixelRatioSetting = modalContent.querySelector('#pixel-ratio-setting') as HTMLElement;
    const transparentBgSetting = modalContent.querySelector('#transparent-bg-setting') as HTMLElement;
    
    formatSelect.addEventListener('change', (e) => {
      format = (e.target as HTMLSelectElement).value as 'png' | 'svg';
      if (format === 'svg') {
        pixelRatioSetting.style.display = 'none';
        transparentBgSetting.style.display = 'none';
      } else {
        pixelRatioSetting.style.display = 'block';
        transparentBgSetting.style.display = 'block';
      }
    });
    
    pixelRatioSlider.addEventListener('input', (e) => {
      pixelRatio = parseFloat((e.target as HTMLInputElement).value);
      pixelRatioValue.textContent = pixelRatio.toFixed(1);
    });
    
    modalContent.querySelector('#export-cancel')?.addEventListener('click', () => {
      document.body.removeChild(modal);
    });
    
    modalContent.querySelector('#export-save')?.addEventListener('click', async () => {
      theme = (modalContent.querySelector('#export-theme') as HTMLSelectElement).value as 'light' | 'dark';
      watermark = (modalContent.querySelector('#export-watermark') as HTMLInputElement).checked;
      privacyMode = (modalContent.querySelector('#export-privacy') as HTMLInputElement).checked;
      transparentBg = (modalContent.querySelector('#export-transparent') as HTMLInputElement).checked;
      
      document.body.removeChild(modal);
      await exportGraphAsImage(format, pixelRatio, theme, watermark, privacyMode, transparentBg);
    });
    
    // –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        document.body.removeChild(modal);
      }
    });
  }
  
  // –≠–∫—Å–ø–æ—Ä—Ç –≥—Ä–∞—Ñ–∞ –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  async function exportGraphAsImage(
    format: 'png' | 'svg' = 'png',
    pixelRatio: number = 2,
    theme: 'light' | 'dark' = 'light',
    watermark: boolean = false,
    privacyMode: boolean = false,
    transparentBg: boolean = false
  ) {
    if (!graph || !container) return;
    
    try {
      const { toPng, toSvg } = await import('html-to-image');
      
      // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ç–µ–º—É
      const currentTheme = document.body.classList.contains('theme-dark') ? 'dark' : 'light';
      
      // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–º—É –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
      if (theme !== currentTheme) {
        document.body.classList.toggle('theme-dark', theme === 'dark');
        document.body.classList.toggle('theme-light', theme === 'light');
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      // –°–±—Ä–æ—Å–∏—Ç—å zoom –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      graph.zoomToFit(400);
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // –ü—Ä–∏–º–µ–Ω–∏—Ç—å privacy mode
      if (privacyMode) {
        container.classList.add('privacy-mode');
      }
      
      const options: {
        quality: number;
        pixelRatio?: number;
        backgroundColor?: string;
        cacheBust: boolean;
        filter: (node: Node) => boolean;
      } = {
        quality: 1.0,
        pixelRatio: format === 'png' ? pixelRatio : undefined,
        backgroundColor: transparentBg && format === 'png' ? undefined : 
          (theme === 'dark' ? '#1f2937' : '#ffffff'),
        cacheBust: true,
        filter: (node: Node) => {
          return !(node as Element).id?.includes('context-menu') &&
                 !(node as Element).id?.includes('export-modal');
        },
      };
      
      const dataUrl = format === 'png' 
        ? await toPng(container, options)
        : await toSvg(container, options);
      
      // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–º—É
      if (theme !== currentTheme) {
        document.body.classList.toggle('theme-dark', currentTheme === 'dark');
        document.body.classList.toggle('theme-light', currentTheme === 'light');
      }
      
      // –£–±—Ä–∞—Ç—å privacy mode
      if (privacyMode) {
        container.classList.remove('privacy-mode');
      }
      
      // –î–æ–±–∞–≤–∏—Ç—å watermark (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      let finalDataUrl = dataUrl;
      if (watermark && format === 'png') {
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å watermark —á–µ—Ä–µ–∑ canvas
        // –ü–æ–∫–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ —Å–ª–æ–∂–Ω–µ–µ
      }
      
      // –°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      const link = document.createElement('a');
      link.download = `graph-knowledge-${lang}-${new Date().toISOString().split('T')[0]}.${format}`;
      link.href = finalDataUrl;
      link.click();
      
      showNotification('–ì—Ä–∞—Ñ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!', 'success');
    } catch (error) {
      if (import.meta.env.DEV) {
        console.error('Export error:', error);
      }
      showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.', 'error');
    }
  }
  
  // –í—ã–±–æ—Ä —Ä—ë–±–µ—Ä –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é
  function selectEdgesByDirection(nodeId: string, direction: 'incoming' | 'outgoing' | 'connected') {
    if (!graph || !allData) return;
    
    const edgesToHighlight = allData.edges.filter(edge => {
      if (direction === 'incoming') {
        return edge.to === nodeId;
      } else if (direction === 'outgoing') {
        return edge.from === nodeId;
      } else {
        // connected - –≤—Å–µ —Å–≤—è–∑–∏ —É–∑–ª–∞
        return edge.from === nodeId || edge.to === nodeId;
      }
    });
    
    const connectedNodeIds = new Set<string>([nodeId]);
    edgesToHighlight.forEach(edge => {
      connectedNodeIds.add(edge.from);
      connectedNodeIds.add(edge.to);
    });
    
    // –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ —É–∑–ª—ã
    const originalNodeColor = graph.nodeColor();
    graph.nodeColor((node: GraphNode) => {
      const baseColor = typeof originalNodeColor === 'function' ? originalNodeColor(node) : getDefaultNodeColor(node);
      if (connectedNodeIds.has(node.id)) {
        return baseColor;
      }
      return addOpacityToColor(baseColor, 0.2);
    });
    
    // –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä—ë–±—Ä–∞
    const originalLinkColor = graph.linkColor();
    graph.linkColor((link: ForceGraphLink) => {
      const sourceId = typeof link.source === 'string' ? link.source : link.source?.id;
      const targetId = typeof link.target === 'string' ? link.target : link.target?.id;
      const isSelected = edgesToHighlight.some(e => 
        (e.from === sourceId && e.to === targetId) || 
        (e.from === targetId && e.to === sourceId)
      );
      
      if (isSelected) {
        return '#fbbf24'; // –Ø—Ä–∫–∏–π –∂—ë–ª—Ç—ã–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä—ë–±–µ—Ä
      }
      return typeof originalLinkColor === 'function' ? originalLinkColor(link) : 'rgba(148, 163, 184, 0.2)';
    });
    
    showNotification(`–í—ã–¥–µ–ª–µ–Ω–æ ${edgesToHighlight.length} —Å–≤—è–∑–µ–π`, 'success');
  }
  
  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  function showNotification(message: string, type: 'success' | 'warning' | 'error' = 'success') {
    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 px-4 py-3 rounded-md shadow-lg z-50 ${
      type === 'success' ? 'bg-green-500 text-white' :
      type === 'warning' ? 'bg-yellow-500 text-black' :
      'bg-red-500 text-white'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }
  
  // Zoom –∫–æ–Ω—Ç—Ä–æ–ª—ã - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  let zoomControlsInitialized = false;
  
  function setupZoomControls() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
    if (zoomControlsInitialized) {
      return;
    }
    zoomControlsInitialized = true;
    
    const zoomInBtn = document.getElementById('zoom-in');
    const zoomOutBtn = document.getElementById('zoom-out');
    const zoomFitBtn = document.getElementById('zoom-fit');
    const zoomResetBtn = document.getElementById('zoom-reset');
    
    zoomInBtn?.addEventListener('click', () => {
      if (graph) {
        const currentZoom = graph.zoom() || 1;
        graph.zoom(currentZoom * 1.2);
      }
    });
    
    zoomOutBtn?.addEventListener('click', () => {
      if (graph) {
        const currentZoom = graph.zoom() || 1;
        graph.zoom(currentZoom / 1.2);
      }
    });
    
    zoomFitBtn?.addEventListener('click', () => {
      if (graph) {
        graph.zoomToFit(400);
      }
    });
    
    zoomResetBtn?.addEventListener('click', () => {
      if (graph) {
        graph.zoom(1);
        graph.centerAt(0, 0);
      }
    });
  }
  
  // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ init
  let initInProgress = false;
  
  
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  document.getElementById('filter-type')?.addEventListener('change', applyFilters);
  document.getElementById('filter-tags')?.addEventListener('change', applyFilters);
  document.getElementById('filter-link-type')?.addEventListener('change', applyFilters);
  document.getElementById('reset-filters')?.addEventListener('click', resetFilters);
  
  // –ü–æ–∏—Å–∫ —É–∑–ª–æ–≤
  const searchInput = document.getElementById('search-nodes') as HTMLInputElement;
  const clearSearchBtn = document.getElementById('clear-search') as HTMLButtonElement;
  
  let searchTimeout: ReturnType<typeof setTimeout> | null = null;
  searchInput?.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement;
    const value = target.value;
    
    if (value.trim()) {
      clearSearchBtn.style.display = 'block';
    } else {
      clearSearchBtn.style.display = 'none';
      clearSearch();
    }
    
    // Debounce –ø–æ–∏—Å–∫–∞
    if (searchTimeout) clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      if (value.trim()) {
        searchNodes(value);
      }
    }, GRAPH_CONSTANTS.DEBOUNCE_SEARCH_MS);
  });
  
  clearSearchBtn?.addEventListener('click', () => {
    searchInput.value = '';
    clearSearchBtn.style.display = 'none';
    clearSearch();
  });
  
  // –†–µ–∂–∏–º —Ñ–æ–∫—É—Å–∞
  document.getElementById('focus-mode')?.addEventListener('click', toggleFocusMode);
  
  // –≠–∫—Å–ø–æ—Ä—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  document.getElementById('export-image')?.addEventListener('click', showExportModal);
  
  // –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
  document.getElementById('export-json')?.addEventListener('click', () => {
    if (!graph || !allData) {
      showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
      return;
    }
    
    try {
      const exportData = {
        nodes: allData.nodes,
        edges: allData.edges,
        metadata: {
          exportedAt: new Date().toISOString(),
          language: lang,
          nodeCount: allData.nodes.length,
          edgeCount: allData.edges.length,
        },
      };
      
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `graph-knowledge-${lang}-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      showNotification('–ì—Ä–∞—Ñ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ JSON!', 'success');
    } catch (error) {
      if (import.meta.env.DEV) {
        console.error('Export JSON error:', error);
      }
      showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ JSON', 'error');
    }
  });
  
  // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
  document.getElementById('context-copy-node')?.addEventListener('click', async () => {
    if (contextMenuNode) {
      try {
        await navigator.clipboard.writeText(JSON.stringify(contextMenuNode, null, 2));
        showNotification('–î–∞–Ω–Ω—ã–µ —É–∑–ª–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!', 'success');
      } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
      }
    }
    hideContextMenu();
  });
  
  document.getElementById('context-open-new')?.addEventListener('click', () => {
    if (contextMenuNode) {
      window.open(`/${lang}/${contextMenuNode.id}/`, '_blank');
    }
    hideContextMenu();
  });
  
  document.getElementById('context-highlight-connections')?.addEventListener('click', () => {
    if (contextMenuNode) {
      highlightConnections(contextMenuNode.id);
    }
    hideContextMenu();
  });
  
  // –ó–∞–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
  document.addEventListener('click', (e) => {
    const menu = document.getElementById('context-menu');
    if (menu && !menu.contains(e.target as Node)) {
      hideContextMenu();
    }
  });
  
  // –ó–∞–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –ø—Ä–∞–≤–æ–º –∫–ª–∏–∫–µ
  document.addEventListener('contextmenu', (e) => {
    const menu = document.getElementById('context-menu');
    if (menu && !menu.contains(e.target as Node)) {
      hideContextMenu();
    }
  });
  
  // ‚ö°Ô∏è PERF: Lazy loading –≥—Ä–∞—Ñ–∞ —Å IntersectionObserver
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∏–¥–µ–Ω –≤ viewport
  // –≠—Ç–æ —É–º–µ–Ω—å—à–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–π bundle size –∏ —É–ª—É—á—à–∞–µ—Ç LCP
  function setupLazyLoading() {
    const container = document.getElementById('graph-container');
    if (!container) {
      // Fallback: –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ä–∞–∑—É
      init();
      return;
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º IntersectionObserver –¥–ª—è lazy loading
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          observer.disconnect();
          
          // ‚ö°Ô∏è PERF: –ò—Å–ø–æ–ª—å–∑—É–µ–º requestIdleCallback –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ idle time
          // –ï—Å–ª–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º setTimeout —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
          if ('requestIdleCallback' in window) {
            requestIdleCallback(() => {
              init();
            }, { timeout: 2000 });
          } else {
            setTimeout(() => {
              init();
            }, 100);
          }
        }
      });
    }, {
      rootMargin: '50px', // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∑–∞ 50px –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –≤ viewport
    });
    
    observer.observe(container);
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ View Transitions
  // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–Ω—ã–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è
  document.addEventListener('keydown', (e) => {
    // –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    const activeElement = document.activeElement;
    if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
      // –†–∞–∑—Ä–µ—à–∏—Ç—å —Ç–æ–ª—å–∫–æ Esc –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø–æ–∏—Å–∫–∞
      if (e.key === 'Escape') {
        const searchInput = document.getElementById('search-nodes') as HTMLInputElement;
        if (activeElement === searchInput) {
          searchInput.value = '';
          clearSearch();
        }
      }
      return;
    }
    
    // Ctrl+F / Cmd+F - —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–∏—Å–∫
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
      e.preventDefault();
      const searchInput = document.getElementById('search-nodes') as HTMLInputElement;
      searchInput?.focus();
      searchInput?.select();
      return;
    }
    
    // Esc - –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã
    if (e.key === 'Escape') {
      const searchInput = document.getElementById('search-nodes') as HTMLInputElement;
      if (searchInput && searchInput.value.trim()) {
        searchInput.value = '';
        clearSearch();
      } else {
        resetFilters();
      }
      return;
    }
    
    // + –∏–ª–∏ = - zoom in
    if (e.key === '+' || e.key === '=') {
      e.preventDefault();
      if (graph) {
        const currentZoom = graph.zoom() || 1;
        graph.zoom(currentZoom * 1.2);
      }
      return;
    }
    
    // - - zoom out
    if (e.key === '-') {
      e.preventDefault();
      if (graph) {
        const currentZoom = graph.zoom() || 1;
        graph.zoom(currentZoom / 1.2);
      }
      return;
    }
    
    // 0 - reset zoom
    if (e.key === '0') {
      e.preventDefault();
      if (graph) {
        graph.zoom(1);
        graph.zoomToFit(400);
      }
      return;
    }
  });
  
  document.addEventListener('astro:page-load', () => {
    highlightedNodeId = null;
    zoomControlsInitialized = false; // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ –¥–ª—è –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤
    setupLazyLoading();
  });
  
  // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å lazy loading
  setupLazyLoading();
</script>
