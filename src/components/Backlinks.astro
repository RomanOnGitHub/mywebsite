---
import { SUPPORTED_LOCALES, type Locale } from '@/utils/slugs';

interface Props {
  slug: string;
  lang: string;
}

const { slug, lang } = Astro.props;
const locale = lang as Locale;
---

<backlinks-component data-slug={slug} data-lang={locale}></backlinks-component>

<script>
  import { escapeHtml } from '@/utils/escape-html';
  
  class BacklinksComponent extends HTMLElement {
    async connectedCallback() {
      await this.loadBacklinks();
      document.addEventListener('astro:page-load', () => this.loadBacklinks());
    }
    
    async loadBacklinks() {
      const lang = this.dataset.lang || 'ru';
      const slug = this.dataset.slug;
      
      if (!slug) {
        this.innerHTML = '';
        return;
      }
      
      try {
        const { fetchWithTimeout } = await import('@/utils/fetch-with-timeout');
        const res = await fetchWithTimeout(`/graph-data-${lang}.json`, {}, 10000);
        
        const graph = await res.json();
        
        // Формируем полный ID текущей страницы (collection/slug)
        // slug может быть вида "blog/my-post" или просто "my-post"
        const currentId = slug.includes('/') ? slug : `blog/${slug}`;
        
        // Backlinks: edges, где target = текущий slug
        const backlinks = graph.edges
          .filter((e: { to: string }) => {
            // Проверяем, что to заканчивается на наш slug
            return e.to === currentId || e.to.endsWith('/' + slug) || e.to.endsWith('/' + currentId);
          })
          .map((e: { from: string }) => {
            const node = graph.nodes.find((n: { id: string }) => n.id === e.from);
            return node;
          })
          .filter(Boolean);
        
        // Related: edges, где source = текущий slug (исходящие ссылки)
        const related = graph.edges
          .filter((e: { from: string }) => {
            return e.from === currentId || e.from.endsWith('/' + slug) || e.from.endsWith('/' + currentId);
          })
          .map((e: { to: string }) => {
            const node = graph.nodes.find((n: { id: string }) => n.id === e.to);
            return node;
          })
          .filter(Boolean);
        
        // Рендерим компонент
        this.render(backlinks, related, lang);
      } catch (error) {
        // Логируем ошибки для отладки (только в dev режиме)
        if (import.meta.env.DEV) {
          console.error('Error loading backlinks:', error);
        }
        // Показываем пустое состояние при ошибке
        this.innerHTML = '';
      }
    }
    
    getLocalizedPath(path: string, lang: string): string {
      const normalizedPath = path.replace(/^\/+|\/+$/g, '');
      if (!normalizedPath) {
        return `/${lang}/`;
      }
      const pathWithSlash = normalizedPath.endsWith('/') ? normalizedPath : `${normalizedPath}/`;
      return `/${lang}/${pathWithSlash}`;
    }
    
    escapeHtml(text: string): string {
      return escapeHtml(text);
    }
    
    render(backlinks: Array<{ id: string; title: string; type?: string }>, related: Array<{ id: string; title: string; type?: string }>, lang: string) {
      if (backlinks.length === 0 && related.length === 0) {
        this.innerHTML = '';
        return;
      }
      
      let html = '<div class="space-y-6">';
      
      // Backlinks секция
      if (backlinks.length > 0) {
        html += `
          <section>
            <h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-gray-100">
              Упоминается в
            </h3>
            <ul class="space-y-2">
              ${backlinks.map(node => `
                <li>
                  <a 
                    href="${this.getLocalizedPath(node.id, lang)}" 
                    class="text-blue-600 dark:text-blue-400 hover:underline transition-colors"
                  >
                    ${this.escapeHtml(node.title)}
                  </a>
                  ${node.type ? `<span class="text-xs text-gray-500 dark:text-gray-400 ml-2">(${node.type})</span>` : ''}
                </li>
              `).join('')}
            </ul>
          </section>
        `;
      }
      
      // Related секция
      if (related.length > 0) {
        html += `
          <section>
            <h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-gray-100">
              Связанные материалы
            </h3>
            <ul class="space-y-2">
              ${related.map(node => `
                <li>
                  <a 
                    href="${this.getLocalizedPath(node.id, lang)}" 
                    class="text-blue-600 dark:text-blue-400 hover:underline transition-colors"
                  >
                    ${this.escapeHtml(node.title)}
                  </a>
                  ${node.type ? `<span class="text-xs text-gray-500 dark:text-gray-400 ml-2">(${node.type})</span>` : ''}
                </li>
              `).join('')}
            </ul>
          </section>
        `;
      }
      
      html += '</div>';
      this.innerHTML = html;
    }
  }
  
  customElements.define('backlinks-component', BacklinksComponent);
</script>
