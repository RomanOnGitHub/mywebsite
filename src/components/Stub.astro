---
interface Props {
  slug: string;
  lang: string;
  collection: string;
}

const { slug, lang, collection } = Astro.props;
// Получаем API ключ из astro:env на сервере и передаём в клиентский скрипт
// Используем безопасный доступ с проверкой наличия Astro.env
const apiKey = (typeof Astro !== 'undefined' && Astro.env?.PUBLIC_WEB3FORMS_KEY) || '';
---

<meta name="robots" content="noindex, nofollow" />

<article class="max-w-2xl mx-auto py-16 px-4">
  <h1 class="text-3xl font-bold mb-4">Контент готовится</h1>
  <p class="text-lg text-gray-600 dark:text-gray-400 mb-8">
    Эта страница ещё не переведена на выбранный язык ({lang}).
  </p>
  
  <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6 mb-8">
    <h2 class="text-xl font-semibold mb-2">Запросить перевод</h2>
    <p class="text-sm text-gray-700 dark:text-gray-300 mb-4">
      Оставьте свой email, и мы уведомим вас, когда контент будет переведён.
    </p>
    
    <div id="form-message" class="mb-4 hidden"></div>
    
    <form 
      class="space-y-4"
      id="translation-request-form"
      data-api-key={apiKey}
    >
      <input type="hidden" name="slug" value={slug} />
      <input type="hidden" name="collection" value={collection} />
      <input type="hidden" name="requested_lang" value={lang} />
      
      <!-- Honeypot поле для защиты от ботов (должно быть пустым) -->
      <div class="honeypot-field" aria-hidden="true" style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;">
        <label for="website">Website (не заполняйте это поле)</label>
        <input 
          type="text" 
          name="website" 
          id="website" 
          autocomplete="off"
          tabindex="-1"
        />
      </div>
      
      <!-- Скрытое поле для проверки JavaScript и времени заполнения -->
      <input type="hidden" name="js_token" id="js-token" />
      <input type="hidden" name="form_start_time" id="form-start-time" />
      
      <div>
        <label 
          for="email" 
          class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
        >
          Email для уведомления:
        </label>
        <input 
          type="email" 
          name="email" 
          id="email" 
          required 
          class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-4 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="your@email.com"
        />
      </div>
      
      <div>
        <label 
          for="message" 
          class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
        >
          Дополнительная информация (необязательно):
        </label>
        <textarea 
          name="message" 
          id="message" 
          rows="3"
          class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-4 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="Любые дополнительные пожелания..."
        ></textarea>
      </div>
      
      <button 
        type="submit" 
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-3 rounded-md transition-colors"
      >
        Запросить перевод
      </button>
    </form>
  </div>
  
  <div class="text-sm text-gray-500 dark:text-gray-400">
    <p>
      Пока вы можете просмотреть этот контент на других доступных языках или вернуться на главную страницу.
    </p>
  </div>
</article>

<script>
  // Обработка отправки формы с Zod валидацией и защитой от ботов
  // Примечание: Astro Actions требуют SSR mode с adapter для static sites
  // В текущей конфигурации (output: 'static') используем клиентскую валидацию с Zod
  
  import { validateTranslationRequest } from '@/utils/form-validation';
  import { 
    checkRateLimit, 
    checkFormTime, 
    initFormTimer, 
    generateJSToken, 
    validateJSToken 
  } from '@/utils/form-protection';
  
  const form = document.getElementById('translation-request-form') as HTMLFormElement;
  const messageDiv = document.getElementById('form-message') as HTMLDivElement;
  const emailInput = document.getElementById('email') as HTMLInputElement;
  const jsTokenInput = document.getElementById('js-token') as HTMLInputElement;
  const formStartTimeInput = document.getElementById('form-start-time') as HTMLInputElement;
  
  // Инициализация защиты при загрузке страницы
  const formStartTime = initFormTimer();
  if (formStartTimeInput) {
    formStartTimeInput.value = formStartTime.toString();
  }
  if (jsTokenInput) {
    jsTokenInput.value = generateJSToken();
  }
  
  function showMessage(type: 'success' | 'error', message: string) {
    if (!messageDiv) return;
    
    messageDiv.className = `mb-4 p-4 ${
      type === 'success' 
        ? 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800' 
        : 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800'
    } rounded-lg`;
    messageDiv.innerHTML = `<p class="${
      type === 'success' 
        ? 'text-green-800 dark:text-green-200' 
        : 'text-red-800 dark:text-red-200'
    } font-medium">${type === 'success' ? '✓' : '✗'} ${message}</p>`;
    messageDiv.classList.remove('hidden');
  }
  
  function showValidationErrors(errors: Record<string, string>) {
    // Показываем первую ошибку валидации
    const firstError = Object.values(errors)[0];
    if (firstError) {
      showMessage('error', firstError);
      
      // Подсвечиваем поле с ошибкой
      if (emailInput && errors.email) {
        emailInput.classList.add('border-red-500', 'focus:ring-red-500');
        emailInput.addEventListener('input', () => {
          emailInput.classList.remove('border-red-500', 'focus:ring-red-500');
        }, { once: true });
      }
    }
  }
  
  if (form && messageDiv) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      const originalText = submitButton?.textContent;
      
      // Скрываем предыдущее сообщение
      messageDiv.classList.add('hidden');
      
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Отправка...';
      }
      
      try {
        // 1. Проверка Honeypot поля (защита от ботов)
        const honeypotValue = formData.get('website');
        if (honeypotValue && (honeypotValue as string).trim() !== '') {
          // Бот обнаружил - молча отклоняем (не показываем ошибку)
          console.warn('Bot detected via honeypot field');
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = originalText || 'Запросить перевод';
          }
          // Показываем фейковое сообщение об успехе, чтобы бот не понял
          showMessage('success', 'Запрос успешно отправлен!');
          form.reset();
          return;
        }
        
        // 2. Проверка JavaScript токена (защита от прямых POST запросов)
        const jsToken = formData.get('js_token') as string;
        const formStartTimeValue = formData.get('form_start_time');
        const formStartTimeNum = formStartTimeValue ? parseInt(formStartTimeValue as string, 10) : formStartTime;
        
        if (!validateJSToken(jsToken, formStartTimeNum)) {
          console.warn('Bot detected: invalid JS token or direct POST');
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = originalText || 'Запросить перевод';
          }
          showMessage('error', 'Ошибка безопасности. Пожалуйста, обновите страницу и попробуйте снова.');
          return;
        }
        
        // 3. Проверка времени заполнения формы (слишком быстро = бот)
        const timeCheck = checkFormTime(formStartTimeNum);
        if (!timeCheck.valid) {
          showMessage('error', timeCheck.message || 'Форма заполнена слишком быстро.');
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = originalText || 'Запросить перевод';
          }
          return;
        }
        
        // 4. Проверка rate limiting (ограничение частоты отправок)
        const rateLimitCheck = checkRateLimit();
        if (!rateLimitCheck.allowed) {
          showMessage('error', rateLimitCheck.message || 'Слишком много запросов. Попробуйте позже.');
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = originalText || 'Запросить перевод';
          }
          return;
        }
        
        // 5. Валидация через Zod
        const validation = validateTranslationRequest({
          email: formData.get('email'),
          message: formData.get('message'),
          slug: formData.get('slug'),
          collection: formData.get('collection'),
          requested_lang: formData.get('requested_lang'),
        });
        
        if (!validation.success) {
          showValidationErrors(validation.errors || {});
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = originalText || 'Запросить перевод';
          }
          return;
        }
        
        // Получаем API ключ из data-атрибута формы (передан с сервера через astro:env)
        const apiKey = form.dataset.apiKey;
        if (!apiKey) {
          throw new Error('API ключ не настроен');
        }
        
        // Отправляем на Web3Forms API
        const response = await fetch('https://api.web3forms.com/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            access_key: apiKey,
            subject: `Запрос перевода: ${validation.data!.collection}/${validation.data!.slug} → ${validation.data!.requested_lang}`,
            email: validation.data!.email,
            message: validation.data!.message || '',
            slug: validation.data!.slug,
            collection: validation.data!.collection,
            requested_lang: validation.data!.requested_lang,
          }),
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          showMessage('success', 'Запрос успешно отправлен!');
          
          if (submitButton) {
            submitButton.textContent = '✓ Запрос отправлен!';
            submitButton.classList.add('bg-green-600', 'hover:bg-green-700');
            form.reset();
          }
        } else {
          throw new Error(data.message || 'Ошибка отправки');
        }
      } catch (error) {
        console.error('Error submitting form:', error);
        showMessage('error', error instanceof Error ? error.message : 'Произошла ошибка при отправке запроса');
        
        if (submitButton) {
          submitButton.textContent = originalText || 'Ошибка. Попробуйте снова';
          submitButton.disabled = false;
        }
      }
    });
  }
</script>
