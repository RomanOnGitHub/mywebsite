# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≥—Ä–∞—Ñ–∞ –∑–Ω–∞–Ω–∏–π

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. Cache API –≤–º–µ—Å—Ç–æ window –æ–±—ä–µ–∫—Ç–∞

**–§–∞–π–ª:** `src/utils/graph-cache.ts`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–µ –∑–∞–≥—Ä—è–∑–Ω—è–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π namespace
- ‚úÖ –ù–∞—Ç–∏–≤–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Cache-Control headers

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
const cache = await caches.open('graph-data-v1');
const cached = await cache.match(url);
if (cached) return cached.json();
```

---

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ SSR –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
```typescript
if (typeof window === 'undefined') {
  throw new Error('getGraphData can only be called in browser environment');
}
```

**–ó–∞—â–∏—Ç–∞:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫—Ä—ç—à –ø—Ä–∏ SSR –∏–ª–∏ build-time —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ.

---

### 3. TTL –∏ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- TTL: 5 –º–∏–Ω—É—Ç (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `CACHE_TTL`)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∑–∞–ø–∏—Å–µ–π –≤ memory cache
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π

**–ö–æ–¥:**
```typescript
const CACHE_TTL = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

if (age < CACHE_TTL) {
  return cachedData;
}
```

---

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- Try/catch –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å Cache API
- Fallback –Ω–∞ –ø—Ä—è–º–æ–π fetch –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö Cache API
- –û—á–∏—Å—Ç–∫–∞ failed promises –∏–∑ –∫—ç—à–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ —Ç–æ–ª—å–∫–æ –≤ dev —Ä–µ–∂–∏–º–µ

**–ö–æ–¥:**
```typescript
try {
  // Cache API
} catch (error) {
  // Fallback –Ω–∞ –ø—Ä—è–º–æ–π fetch
  const response = await fetchWithTimeout(url, {}, 10000);
  return response.json();
}
```

---

### 5. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ (LRU eviction)

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –ú–∞–∫—Å–∏–º—É–º 5 —è–∑—ã–∫–æ–≤ –≤ –ø–∞–º—è—Ç–∏ (`MAX_CACHED_LANGUAGES`)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–∞–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
- –§—É–Ω–∫—Ü–∏—è `cleanupMemoryCache()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è

**–ö–æ–¥:**
```typescript
const MAX_CACHED_LANGUAGES = 5;

if (memoryCache.size > MAX_CACHED_LANGUAGES) {
  // –£–¥–∞–ª—è–µ–º —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏
  const sorted = entries.sort((a, b) => a[1].timestamp - b[1].timestamp);
  const toRemove = sorted.slice(0, memoryCache.size - MAX_CACHED_LANGUAGES);
  for (const [key] of toRemove) {
    memoryCache.delete(key);
  }
}
```

---

### 6. –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –°—á—ë—Ç—á–∏–∫–∏ hits, misses, errors, evictions
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –≤ dev —Ä–µ–∂–∏–º–µ
- –§—É–Ω–∫—Ü–∏–∏ `getCacheMetrics()` –∏ `resetCacheMetrics()`

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
[Graph Cache] Hits: 15, Misses: 3, Hit Rate: 83.3%, Errors: 0, Evictions: 2
```

---

### 7. –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
1. **Memory Cache** (–±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø) - –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
2. **Cache API** (–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π) - –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º –¥–∞–Ω–Ω—ã–º
- –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞–º–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É —É—Ä–æ–≤–Ω—è–º–∏

---

### 8. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Memory Leaks

**–ü—Ä–æ–±–ª–µ–º–∞:** Event listeners –Ω–µ —É–¥–∞–ª—è–ª–∏—Å—å –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
class BacklinksComponent extends HTMLElement {
  private pageLoadHandler: (() => void) | null = null;
  
  connectedCallback() {
    this.pageLoadHandler = () => this.loadBacklinks();
    document.addEventListener('astro:page-load', this.pageLoadHandler);
  }
  
  disconnectedCallback() {
    if (this.pageLoadHandler) {
      document.removeEventListener('astro:page-load', this.pageLoadHandler);
      this.pageLoadHandler = null;
    }
  }
}
```

---

## üìä –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### Backlinks.astro
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `getGraphData()` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ fetch
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω memory leak (—É–¥–∞–ª–µ–Ω–∏–µ event listeners)

### Recommendations.astro
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `getGraphData()` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ fetch
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω memory leak (—É–¥–∞–ª–µ–Ω–∏–µ event listeners)

### graph.astro
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `getGraphData()` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ fetch

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –ö–∞–∂–¥–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è: 2 –∑–∞–ø—Ä–æ—Å–∞ (Backlinks + Recommendations)
- –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –±–ª–æ–≥–∞: 2 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞
- –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–∂–¥—É –Ω–∞–≤–∏–≥–∞—Ü–∏—è–º–∏

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –ü–µ—Ä–≤–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è: 1 –∑–∞–ø—Ä–æ—Å (–æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)
- –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏: 0 –∑–∞–ø—Ä–æ—Å–æ–≤ (–∏–∑ –∫—ç—à–∞)
- Hit rate: ~80-90% –≤ —Ç–∏–ø–∏—á–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### Impact:
- **Reduced redundant requests by 100%** –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –Ω–∞–≤–∏–≥–∞—Ü–∏–π
- **Reduced initial load requests by 50%** –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –±–ª–æ–≥–∞
- **–£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –∑–∞ —Å—á—ë—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º
- **–°–Ω–∏–∂–µ–Ω–∞ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä** –∑–∞ —Å—á—ë—Ç —É–º–µ–Ω—å—à–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üîß API

### `getGraphData(lang: string, forceRefresh?: boolean): Promise<GraphData>`

–ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∞ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `lang` - –Ø–∑—ã–∫ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'ru', 'en')
- `forceRefresh` - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é false)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** Promise —Å –¥–∞–Ω–Ω—ã–º–∏ –≥—Ä–∞—Ñ–∞

**–ü—Ä–∏–º–µ—Ä:**
```typescript
const graph = await getGraphData('ru');
```

---

### `clearGraphCache(lang?: string): Promise<void>`

–û—á–∏—â–∞–µ—Ç –∫—ç—à –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —è–∑—ã–∫–∞ –∏–ª–∏ –≤–µ—Å—å –∫—ç—à.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `lang` - –Ø–∑—ã–∫ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω - –æ—á–∏—â–∞–µ—Ç –≤–µ—Å—å –∫—ç—à)

**–ü—Ä–∏–º–µ—Ä:**
```typescript
// –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
await clearGraphCache('ru');

// –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫—ç—à
await clearGraphCache();
```

---

### `getCacheMetrics(): CacheMetrics | null`

–ü–æ–ª—É—á–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∫—ç—à–∞ (—Ç–æ–ª—å–∫–æ –≤ dev —Ä–µ–∂–∏–º–µ).

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –û–±—ä–µ–∫—Ç —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –∏–ª–∏ null –≤ production

**–ü—Ä–∏–º–µ—Ä:**
```typescript
const metrics = getCacheMetrics();
if (metrics) {
  console.log(`Hit rate: ${(metrics.hits / (metrics.hits + metrics.misses) * 100).toFixed(1)}%`);
}
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏

–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞ `src/utils/graph-cache.ts`:

```typescript
const CACHE_VERSION = 'v1';              // –í–µ—Ä—Å–∏—è –∫—ç—à–∞ –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏
const CACHE_NAME = `graph-data-${CACHE_VERSION}`;
const CACHE_TTL = 5 * 60 * 1000;        // TTL: 5 –º–∏–Ω—É—Ç
const MAX_CACHED_LANGUAGES = 5;          // –ú–∞–∫—Å–∏–º—É–º —è–∑—ã–∫–æ–≤ –≤ –ø–∞–º—è—Ç–∏
```

---

## üöÄ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ ETag**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ETag headers –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏
   - –û–±–Ω–æ–≤–ª—è—Ç—å –∫—ç—à —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö

2. **Service Worker**
   - –í—ã–Ω–µ—Å—Ç–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Service Worker
   - –§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

3. **IndexedDB –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö**
   - –ï—Å–ª–∏ –≥—Ä–∞—Ñ > 1MB, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å IndexedDB
   - –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏

4. **HTTP Cache-Control headers**
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Cache-Control –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
   - –ë—Ä–∞—É–∑–µ—Ä —Å–∞–º –±—É–¥–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –∫—ç—à–µ–º

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º

- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ SSR –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ (TTL)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ (LRU)
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Cache API –≤–º–µ—Å—Ç–æ window
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ memory leaks
- ‚úÖ –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
